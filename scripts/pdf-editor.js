import{LitElement as e,css as t,html as a}from"lit";import*as i from"pdfjs-dist";class s extends window.fabric.IText{static get elementType(){return"text"}constructor(e={}){console.log("Creating TextElement with options:",e),super(e.text||"New Text",{id:e.id||Date.now().toString(),fontSize:36,fontFamily:"Arial",fill:"#FF0000",padding:0,lineHeight:1,textAlign:"left",editable:!1,selectable:!0,hasControls:!0,hasBorders:!0,originX:"left",originY:"top",backgroundColor:null,cornerSize:4,transparentCorners:!0,borderColor:"#2196F3",cornerColor:"#2196F3",lockMovementX:!1,lockMovementY:!1,lockRotation:!0,lockScalingX:!0,lockScalingY:!0,...e}),this.set("draggable",!0),this.initializeEventListeners()}initializeEventListeners(){this.on("mousedblclick",(()=>{this.isEditing||this.enterEditing()})),this.on("editing:entered",(()=>{console.log("Editing entered"),this.canvas?.fire("text:editing",{target:this})})),this.on("editing:exited",(()=>{console.log("Editing exited"),this.canvas?.fire("text:changed",{target:this})})),this.on("selected",(()=>{this.canvas?.fire("host",{target:this.getHostProperties(),eventName:"selected:text"})})),this.on("deselected",(()=>{console.log("Text deselected")}))}setText(e){this.set("text",e),this.canvas?.requestRenderAll(),this.canvas?.fire("text:changed",{target:this})}setFontSize(e){this.set("fontSize",e),this.canvas?.requestRenderAll()}setFontFamily(e){this.set("fontFamily",e),this.canvas?.requestRenderAll()}setColor(e){this.set("fill",e),this.canvas?.requestRenderAll()}setTextAlign(e){this.set("textAlign",e),this.canvas?.requestRenderAll()}setBold(e){this.set("fontWeight",e?"bold":"normal"),this.canvas?.requestRenderAll()}setItalic(e){this.set("fontStyle",e?"italic":"normal"),this.canvas?.requestRenderAll()}setLineHeight(e){this.set("lineHeight",e),this.canvas?.requestRenderAll()}setWidth(e){console.log("hmm"),this.set("width",e)}setHeight(e){this.set("height",e)}getHostProperties(){return{text:this.text,fontSize:this.fontSize,fontFamily:this.fontFamily,fill:this.fill,textAlign:this.textAlign,fontWeight:this.fontWeight,fontStyle:this.fontStyle,lineHeight:this.lineHeight,width:this.width,height:this.height,data:this.data}}toJSON(){return{...super.toJSON(),text:this.text,fontSize:this.fontSize,fontFamily:this.fontFamily,fill:this.fill,textAlign:this.textAlign,fontWeight:this.fontWeight,fontStyle:this.fontStyle,lineHeight:this.lineHeight}}}class n extends window.fabric.Image{static get elementType(){return"image"}static globalPlaceholder=null;constructor(e,t={}){let a=e,i=!1,s=null,o=t.src,r={};if(t.data&&(r=t.data),t.data?.hasError){const e=t.width||200,i=t.height||100,s=t.src&&t.src.split("/").pop()||"image";a=n.createPlaceholderImage(s,e,i,!0),r={...t.data,hasError:!0,originalSrc:t.src}}else if(!e&&t.src&&(t.src.startsWith("data:")||t.src.startsWith("http"))){const e=t.width||200,i=t.height||100;a=n.createPlaceholderImage("Loading...",e,i),r={...t.data,needsLoading:!0,originalSrc:t.src}}else if(t.src&&n.isVariableSrc(t.src)){i=!0,s=n.extractVariableName(t.src);const e=t.width||200,l=t.height||100;a=n.createPlaceholderImage(s,e,l),r={...t.data,isVariable:i,variableName:s,originalSrc:o}}super(a,{id:t.id||Date.now().toString(),left:0,top:0,width:t.width||200,height:t.height||100,originX:"left",originY:"top",selectable:!0,hasControls:!0,hasBorders:!0,borderColor:"#2196F3",cornerColor:"#2196F3",cornerSize:10,transparentCorners:!1,lockMovementX:!1,lockMovementY:!1,lockRotation:!1,lockScalingX:!1,lockScalingY:!1,...t,data:r}),i&&this.applyVariableStying(),r.hasError&&this.applyErrorStyling(),this.set("draggable",!0),this.initializeEventListeners(),r.needsLoading&&r.originalSrc&&setTimeout((()=>{this._loadImageFromUrl(r.originalSrc)}),0),i&&n.globalPlaceholder&&setTimeout((()=>{this.applyVariableData(n.globalPlaceholder,!1)}),0)}static isVariableSrc(e){return"string"==typeof e&&/\{\{[^}]+\}\}/.test(e)}static extractVariableName(e){const t=e.match(/\{\{([^}]+)\}\}/);return t?t[1].trim():null}static createPlaceholderImage(e,t=null,a=null,i=!1){const s=document.createElement("canvas"),n=s.getContext("2d"),o=t||200,r=a||100;s.width=o,s.height=r,n.fillStyle=i?"#ffeaea":"#f0f0f0",n.fillRect(0,0,s.width,s.height),n.strokeStyle=i?"#DC3545":"#cccccc",n.lineWidth=Math.max(1,.01*Math.min(s.width,s.height));const l=n.lineWidth;n.strokeRect(l/2,l/2,s.width-l,s.height-l);const d=Math.min(s.width,s.height),c=Math.max(20,.2*d),h=Math.max(10,.12*d);n.fillStyle=i?"#DC3545":"#999999";const g=(s.width-c)/2,m=(s.height-c)/2-h;if(n.fillRect(g,m,.7*c,.5*c),n.beginPath(),n.moveTo(g+.8*c,m+.25*c),n.lineTo(g+c,m),n.lineTo(g+c,m+.5*c),n.closePath(),n.fill(),i){const e=.3*c,t=g+.75*c,a=m-.5*e;n.fillStyle="#DC3545",n.beginPath(),n.arc(t+e/2,a+e/2,e/2,0,2*Math.PI),n.fill(),n.strokeStyle="#ffffff",n.lineWidth=Math.max(1,.2*e),n.beginPath(),n.moveTo(t+.25*e,a+.25*e),n.lineTo(t+.75*e,a+.75*e),n.moveTo(t+.75*e,a+.25*e),n.lineTo(t+.25*e,a+.75*e),n.stroke()}n.fillStyle=i?"#DC3545":"#666666",n.font=`${h}px Arial`,n.textAlign="center",n.textBaseline="middle";const p=`{{${e}}}`,u=m+.5*c+1.5*h,f=i?"Failed to load":null,v=u+h+5,b=s.width-20;if(n.measureText(p).width>b){const t=e.length>10?`{{${e.substring(0,10)}...}}`:p;n.fillText(t,s.width/2,u)}else n.fillText(p,s.width/2,u);return i&&f&&(n.font=.8*h+"px Arial",n.fillStyle="#DC3545",n.fillText(f,s.width/2,v)),s}applyVariableStying(){this.set({stroke:"#FF6B35",strokeWidth:2,strokeDashArray:[5,5]})}removeVariableStying(){this.set({stroke:null,strokeWidth:0,strokeDashArray:null})}applyErrorStyling(){this.set({stroke:"#DC3545",strokeWidth:2,strokeDashArray:[5,5]})}_loadImageFromUrl(e){const t={left:this.left,top:this.top,scaleX:this.scaleX,scaleY:this.scaleY,angle:this.angle,id:this.id,data:this.data};window.fabric.Image.fromURL(e,(e=>{e&&e.getElement&&e.getElement()?(this.setElement(e.getElement()),this.set({...t,width:e.width,height:e.height}),delete this.data.needsLoading,this.setCoords(),this.canvas?.requestRenderAll()):(this.data.hasError=!0,delete this.data.needsLoading,this.applyErrorStyling())}),{crossOrigin:"anonymous"})}setSrc(e){this.data;const t=n.isVariableSrc(e),a=this.getScaledWidth(),i=this.getScaledHeight(),s={id:this.id,oUID:this.oUID,left:this.left,top:this.top,angle:this.angle,opacity:this.opacity,originX:this.originX,originY:this.originY,selectable:this.selectable,hasControls:this.hasControls,hasBorders:this.hasBorders,borderColor:this.borderColor,cornerColor:this.cornerColor};if(this.data={...this.data,isVariable:t,variableName:t?n.extractVariableName(e):null,originalSrc:e},t){const t=n.extractVariableName(e),o=n.createPlaceholderImage(t,a,i);this.setElement(o),this.set({...s,width:a,height:i,scaleX:1,scaleY:1}),this.applyVariableStying(),console.log("Image converted to variable with rendered dimensions:",a,"x",i),n.globalPlaceholder&&(console.log(`ðŸ–¼ï¸ Applying global placeholder to converted variable ${t}:`,n.globalPlaceholder),setTimeout((()=>{this.applyVariableData(n.globalPlaceholder,!1)}),0))}else{this.removeVariableStying();const t=setTimeout((()=>{this.data={...this.data,hasError:!0,originalSrc:e},this._showErrorPlaceholder(a,i,s)}),2e3);window.fabric.Image.fromURL(e,(n=>{const o=n.getElement?n.getElement():null;if(clearTimeout(t),n&&n.getElement&&n.getElement()&&o&&o.complete&&o.width&&o.height){this.setElement(n.getElement());const e=a/n.width,t=i/n.height;this.set({...s,width:n.width,height:n.height,scaleX:e,scaleY:t}),this.setCoords(),this.canvas?.requestRenderAll()}else this.data={...this.data,hasError:!0,originalSrc:e},this._showErrorPlaceholder(a,i,s)}),{crossOrigin:"anonymous"})}this.notifyImageChanged(),this.canvas?.requestRenderAll()}setVariableName(e){const t=`{{${e}}}`;this.setSrc(t)}notifyImageChanged(){this.canvas?.fire("host",{eventName:"image:changed",target:this,variableInfo:{isVariable:this.data?.isVariable,variableName:this.data?.variableName,originalSrc:this.data?.originalSrc}})}applyVariableData(e,t=!0){if(!this.data?.isVariable)return Promise.resolve();console.log(`Applying variable data to ${this.data.variableName}:`,e),t&&!this._previewState&&(this._previewState={element:this.getElement(),properties:{id:this.id,oUID:this.oUID,left:this.left,top:this.top,renderedWidth:this.getScaledWidth(),renderedHeight:this.getScaledHeight(),width:this.width,height:this.height,scaleX:this.scaleX,scaleY:this.scaleY,angle:this.angle,opacity:this.opacity,originX:this.originX,originY:this.originY,selectable:this.selectable,hasControls:this.hasControls,hasBorders:this.hasBorders,borderColor:this.borderColor,cornerColor:this.cornerColor,cornerSize:this.cornerSize,transparentCorners:this.transparentCorners,stroke:this.stroke,strokeWidth:this.strokeWidth,strokeDashArray:this.strokeDashArray}});const a=this.getScaledWidth(),i=this.getScaledHeight(),s={id:this.id,oUID:this.oUID,left:this.left,top:this.top,angle:this.angle,opacity:this.opacity,originX:this.originX,originY:this.originY,selectable:this.selectable,hasControls:this.hasControls,hasBorders:this.hasBorders,borderColor:this.borderColor,cornerColor:this.cornerColor,cornerSize:this.cornerSize,transparentCorners:this.transparentCorners};return console.log("Target dimensions:",{targetRenderedWidth:a,targetRenderedHeight:i}),new Promise(((n,o)=>{const r=setTimeout((()=>{console.warn(`Image loading timeout: ${e}`),this._showErrorPlaceholder(a,i,s),n()}),1e4);window.fabric.Image.fromURL(e,(o=>{if(clearTimeout(r),o&&o.getElement&&o.width&&o.height)try{this.setElement(o.getElement());const e=o.width,r=o.height;if(console.log("New image natural dimensions:",{width:e,height:r}),e<=0||r<=0)return console.warn(`Invalid image dimensions: ${e}x${r}, showing error placeholder`),this._showErrorPlaceholder(a,i,s),void n();const l=a/e,d=i/r;console.log("Calculated scales:",{scaleX:l,scaleY:d}),this.set({...s,scaleX:l,scaleY:d,width:e,height:r}),t?this.removeVariableStying():delete this.data.hasError,this.setCoords(),this.canvas?.requestRenderAll(),console.log("Variable data applied with dimensions:",{naturalWidth:this.width,naturalHeight:this.height,scaleX:this.scaleX,scaleY:this.scaleY,renderedWidth:this.getScaledWidth(),renderedHeight:this.getScaledHeight()}),n()}catch(e){console.error("Error applying variable image data:",e),this._showErrorPlaceholder(a,i,s),n()}else console.warn(`Failed to load image from URL: ${e}`),this._showErrorPlaceholder(a,i,s),n()}),{crossOrigin:"anonymous"})}))}_showErrorPlaceholder(e,t,a){const i=this.data?.variableName||(this.data?.originalSrc?this.data.originalSrc.split("/").pop():"image");console.log(`ðŸ”´ Showing error placeholder for ${i}`),this.data.hasError=!0;const s=e&&isFinite(e)&&e>0?e:200,o=t&&isFinite(t)&&t>0?t:100;console.log(`ðŸ”´ Using safe dimensions: ${s}x${o} (original: ${e}x${t})`);const r=n.createPlaceholderImage(i,s,o,!0);this.setElement(r),this.set({...a,width:s,height:o,scaleX:1,scaleY:1}),this.set({stroke:"#DC3545",strokeWidth:2,strokeDashArray:[5,5]}),this.setCoords(),this.canvas?.requestRenderAll(),console.log(`ðŸ”´ Error placeholder displayed for ${this.data.variableName}`)}clearVariableData(){if(this.data?.isVariable){if(console.log(`Clearing variable data for ${this.data.variableName}`),delete this.data.hasError,this._previewState)this.setElement(this._previewState.element),this.set(this._previewState.properties),this._previewState=null;else{const e=this.getScaledWidth(),t=this.getScaledHeight(),a=n.createPlaceholderImage(this.data.variableName,e,t,!1);this.setElement(a),this.set({width:e,height:t,scaleX:1,scaleY:1}),this.applyVariableStying()}this.setCoords(),this.canvas?.requestRenderAll(),console.log("Variable data cleared, template state restored")}}initializeEventListeners(){this.on("selected",(()=>{console.log("Image Selected"),this.canvas?.fire("host",{target:this.getHostProperties(),eventName:"selected:image"})})),this.on("deselected",(()=>{console.log("Image Deselected"),this.canvas?.fire("host",{target:null,eventName:"deselected:image"})}));["moving","scaling","rotating"].forEach((e=>{this.on(e,(()=>{this.canvas?.fire("host",{target:this.getHostProperties(),eventName:"image:transformed"})}))})),this.on("modified",(()=>{this.data?.isVariable&&this.notifyImageChanged()}))}setOpacity(e){this.set("opacity",e),this.canvas?.requestRenderAll()}setWidth(e){this.setScaledWidth(e),this.canvas?.requestRenderAll()}setHeight(e){this.setScaledHeight(e),this.canvas?.requestRenderAll()}setScaledWidth(e){if(0===this.width||0===this.height)return;const t=this.getScaledHeight()/this.getScaledWidth();this.setDimensions(e,e*t)}setScaledHeight(e){if(0===this.width||0===this.height)return;const t=this.getScaledWidth()/this.getScaledHeight();this.setDimensions(e*t,e)}setDimensions(e,t,a=!0){const i=this.width,s=this.height;if(0===i||0===s)return void console.warn("ImageElement: Cannot set dimensions. Original width or height is zero.");let n=e/i,o=t/s;if(a){const a=Math.min(e/i,t/s);n=a,o=a}(isNaN(n)||!isFinite(n)||n<=0)&&(n=this.scaleX),(isNaN(o)||!isFinite(o)||o<=0)&&(o=this.scaleY),this.set({scaleX:n,scaleY:o}),this.setCoords(),this.canvas?.requestRenderAll()}getHostProperties(){return{id:this.id||this.oUID,type:n.elementType,left:this.left,top:this.top,width:this.getScaledWidth(),height:this.getScaledHeight(),scaleX:this.scaleX,scaleY:this.scaleY,angle:this.angle,opacity:this.opacity,src:this.getSrc(),data:this.data,isVariable:this.data?.isVariable||!1,variableName:this.data?.variableName||null,originalSrc:this.data?.originalSrc||null}}toJSON(){return{...super.toJSON(),src:this.data?.originalSrc||this.getSrc(),data:this.data}}static fromURL(e,t={}){return new Promise(((a,i)=>{if(/\{\{[^}]+\}\}/.test(e)){const i=new n(null,{src:e,...t});a(i)}else window.fabric.Image.fromURL(e,(s=>{if(!s)return i(new Error(`Failed to load image from URL: ${e}`));const o=new n(s.getElement(),{width:s.width,height:s.height,scaleX:s.scaleX,scaleY:s.scaleY,...t});a(o)}),{crossOrigin:t.crossOrigin||"anonymous"})}))}}class o extends EventTarget{static States={IDLE:"idle",DRAWING:"drawing",SELECTING:"selecting",TRANSFORMING:"transforming"};constructor(){if(super(),void 0===window.fabric)throw new Error("Fabric.js must be loaded before using ElementManager");this.canvas=null,this.state=o.States.IDLE,this.isRendering=!1,this.pendingRender=!1,this.elements=[],this.selectedElements=[]}initialize(e,t){this.canvas=e,this.hostElement=t,this.setupEventListeners(),this.canvas&&this.syncElementsWithCanvas()}syncElementsWithCanvas(){this.canvas&&(this.elements=[...this.canvas.getObjects()],console.log(`Synced ${this.elements.length} elements from canvas`))}setState(e){const t=this.state;this.state=e,this.dispatchEvent(new CustomEvent("state-changed",{detail:{oldState:t,newState:e}}))}setupEventListeners(){this.canvas&&this.canvas.on({"object:moving":this.handleObjectMoving.bind(this),"object:scaling":this.handleObjectScaling.bind(this),"object:rotating":this.handleObjectRotating.bind(this),"object:modified":this.handleObjectModified.bind(this),"selection:created":this.handleSelectionCreated.bind(this),"selection:updated":this.handleSelectionUpdated.bind(this),"selection:cleared":this.handleSelectionCleared.bind(this),"mouse:down":this.handleMouseDown.bind(this),"mouse:move":this.handleMouseMove.bind(this),"mouse:up":this.handleMouseUp.bind(this),"text:changed":this.handleTextChanged.bind(this),"text:editing:entered":this.handleTextEditingEntered.bind(this),"text:editing:exited":this.handleTextEditingExited.bind(this),host:this.handleHostEvents.bind(this)})}handleHostEvents(e){this._dispatchHostEvent(e.eventName,e.target)}_dispatchHostEvent(e,t){this.hostElement&&this.hostElement instanceof HTMLElement?this.hostElement.dispatchEvent(new CustomEvent(e,{detail:t,bubbles:!0,composed:!0})):console.warn(`ElementManager: Cannot dispatch CustomEvent '${e}'. hostElement is not a valid HTMLElement.`)}handleMouseDown(e){e.target&&(console.log("Mouse down on object:",e.target),this.setState(o.States.SELECTING))}handleMouseMove(e){this.state===o.States.SELECTING&&e.target&&console.log("Moving object:",e.target)}handleMouseUp(e){this.setState(o.States.IDLE)}handleSelectionCreated(e){console.log("Selection created:",e),this.selectedElements=e.selected||[e.target];const t=this.selectedElements.some((e=>e instanceof s||"text"===e.type||"i-text"===e.type));this.dispatchEvent(new CustomEvent("selection-created",{detail:{selected:this.selectedElements,isText:t,target:e.target}})),this._dispatchHostEvent("selection-changed",{detail:{selected:this.selectedElements,isText:t,target:e.target}})}handleSelectionUpdated(e){console.log("Selection updated:",e),this.selectedElements=e.selected||[e.target];const t=this.selectedElements.some((e=>e instanceof s||"text"===e.type||"i-text"===e.type));this.dispatchEvent(new CustomEvent("selection-updated",{detail:{selected:this.selectedElements,isText:t,target:e.target}})),this.dispatchEvent(new CustomEvent("selection-changed",{detail:{selected:this.selectedElements,isText:t,target:e.target}}))}handleSelectionCleared(e){console.log("Selection cleared"),this.selectedElements=[],this.dispatchEvent(new CustomEvent("selection-cleared",{detail:null})),this._dispatchHostEvent("selected:none",{detail:null})}handleObjectModified(e){console.log("Object modified:",e.target),this.dispatchEvent(new CustomEvent("element-modified",{detail:{element:e.target}}))}handleTextChanged(e){console.log("Text changed:",e.target),this.dispatchEvent(new CustomEvent("text-changed",{detail:{element:e.target}}))}handleTextEditingEntered(e){console.log("Text editing entered:",e.target),this.dispatchEvent(new CustomEvent("text-editing-entered",{detail:{element:e.target}}))}handleTextEditingExited(e){console.log("Text editing exited:",e.target),this.dispatchEvent(new CustomEvent("text-editing-exited",{detail:{element:e.target}}))}requestRender(){this.isRendering?this.pendingRender=!0:(this.isRendering=!0,requestAnimationFrame((()=>{this.render(),this.isRendering=!1,this.pendingRender&&(this.pendingRender=!1,this.requestRender())})))}render(){this.canvas&&(this.state===o.States.TRANSFORMING?this.canvas.renderOnAddRemove=!1:this.canvas.renderOnAddRemove=!0,this.canvas.renderAll())}addElement(e){console.log("Adding element to canvas:",e),this.canvas.add(e),this.elements.push(e),this.requestRender(),this.dispatchEvent(new CustomEvent("element-added",{detail:{element:e}}))}removeElement(e){this.canvas.remove(e),this.elements=this.elements.filter((t=>t!==e)),this.requestRender(),this.dispatchEvent(new CustomEvent("element-removed",{detail:{element:e}}))}bringToFront(e){e.bringToFront(),this.requestRender(),this.dispatchEvent(new CustomEvent("z-index-changed"))}sendToBack(e){e.sendToBack(),this.requestRender(),this.dispatchEvent(new CustomEvent("z-index-changed"))}handleObjectMoving(e){const t=e.target;this.dispatchEvent(new CustomEvent("elements-moved",{detail:{element:t}}))}handleObjectScaling(e){const t=e.target;this.dispatchEvent(new CustomEvent("elements-scaled",{detail:{element:t}}))}handleObjectRotating(e){const t=e.target;this.dispatchEvent(new CustomEvent("elements-rotated",{detail:{element:t}}))}addText(e={}){console.log("Adding text with options:",e);const t={text:e.text||"New Text",left:e.left||(this.canvas?this.canvas.width/2:100),top:e.top||(this.canvas?this.canvas.height/2:100),fontSize:e.fontSize||36,fontFamily:e.fontFamily||"Arial",fill:e.fill||"#FF0000",fontWeight:e.fontWeight||"normal",fontStyle:e.fontStyle||"normal",textAlign:e.textAlign||"left",lineHeight:e.lineHeight||1,originX:"left",originY:"top",selectable:!0,hasControls:!0,hasBorders:!0,editable:!1},a=new s({...t,...e});return console.log("Text capabilities:",{selectable:a.selectable,editable:a.editable,hasControls:a.hasControls,hasBorders:a.hasBorders}),this.addElement(a),this.canvas&&(this.canvas.setActiveObject(a),this.canvas.requestRenderAll()),a}addImageFromDataUrl(e,t={}){return new Promise(((a,i)=>{if(n.prototype.isVariableSrc&&n.prototype.isVariableSrc(e)){console.log("Creating variable image from URL:",e);const i=new n(null,{left:t.left||(this.canvas?this.canvas.width/2:0),top:t.top||(this.canvas?this.canvas.height/2:0),src:e,...t});return this.canvas.add(i),this.canvas.setActiveObject(i),this.canvas.requestRenderAll(),void a(i)}const s=setTimeout((()=>{console.warn(`Image loading timeout: ${e}, creating error placeholder`);const i=new n(null,{src:e,left:t.left||(this.canvas?this.canvas.width/2:0),top:t.top||(this.canvas?this.canvas.height/2:0),width:t.width||200,height:t.height||100,data:{hasError:!0},...t});this.canvas.add(i),this.canvas.setActiveObject(i),this.canvas.requestRenderAll(),a(i)}),5e3);window.fabric.Image.fromURL(e,(i=>{if(clearTimeout(s),!i){console.warn(`Failed to load image: ${e}, creating error placeholder`);const i=new n(null,{src:e,left:t.left||(this.canvas?this.canvas.width/2:0),top:t.top||(this.canvas?this.canvas.height/2:0),width:t.width||200,height:t.height||100,data:{hasError:!0},...t});return this.canvas.add(i),this.canvas.setActiveObject(i),this.canvas.requestRenderAll(),void a(i)}if(i.width>300||i.height>300){const e=300/Math.max(i.width,i.height);i.scale(e)}const o=new n(i.getElement(),{left:t.left||(this.canvas?this.canvas.width/2:0),top:t.top||(this.canvas?this.canvas.height/2:0),scaleX:i.scaleX,scaleY:i.scaleY,width:i.width,height:i.height,...t});this.canvas.add(o),this.canvas.setActiveObject(o),this.canvas.requestRenderAll(),a(o)}),{crossOrigin:t.crossOrigin||"anonymous"})}))}addImageVariable(e,t={}){const a=`{{${e}}}`;return this.addImageFromDataUrl(a,t)}getSelectedTextElements(){return this.selectedElements.filter((e=>e instanceof s||"text"===e.type||"i-text"===e.type))}isTextSelected(){return this.getSelectedTextElements().length>0}getActiveTextElement(){const e=this.canvas?.getActiveObject();return e&&(e instanceof s||"text"===e.type||"i-text"===e.type)?e:null}getActiveImageElement(){const e=this.canvas?.getActiveObject();return e&&"image"===e.type?e:null}setFontSize(e){const t=this.getActiveTextElement();t&&(t instanceof s?t.setFontSize(e):(t.set("fontSize",e),this.canvas?.requestRenderAll()),this.dispatchEvent(new CustomEvent("text-modified",{detail:{element:t,property:"fontSize",value:e}})))}setFontFamily(e){const t=this.getActiveTextElement();t&&(t instanceof s?t.setFontFamily(e):(t.set("fontFamily",e),this.canvas?.requestRenderAll()),this.dispatchEvent(new CustomEvent("text-modified",{detail:{element:t,property:"fontFamily",value:e}})))}setText(e){const t=this.getActiveTextElement();t&&(t instanceof s?t.setText(e):(t.set("text",e),this.canvas?.requestRenderAll()),this.dispatchEvent(new CustomEvent("text-modified",{detail:{element:t,property:"text",value:e}})))}setTextColor(e){const t=this.getActiveTextElement();t&&(t instanceof s?t.setColor(e):(t.set("fill",e),this.canvas?.requestRenderAll()),this.dispatchEvent(new CustomEvent("text-modified",{detail:{element:t,property:"color",value:e}})))}setTextBold(e){const t=this.getActiveTextElement();t&&(t instanceof s?t.setBold(e):(t.set("fontWeight",e?"bold":"normal"),this.canvas?.requestRenderAll()),this.dispatchEvent(new CustomEvent("text-modified",{detail:{element:t,property:"bold",value:e}})))}setTextItalic(e){const t=this.getActiveTextElement();t&&(t instanceof s?t.setItalic(e):(t.set("fontStyle",e?"italic":"normal"),this.canvas?.requestRenderAll()),this.dispatchEvent(new CustomEvent("text-modified",{detail:{element:t,property:"italic",value:e}})))}setTextAlign(e){const t=this.getActiveTextElement();t&&(t instanceof s?t.setTextAlign(e):(t.set("textAlign",e),this.canvas?.requestRenderAll()),this.dispatchEvent(new CustomEvent("text-modified",{detail:{element:t,property:"textAlign",value:e}})))}setLineHeight(e){const t=this.getActiveTextElement();t&&(t instanceof s?t.setLineHeight(e):(t.set("lineHeight",e),this.canvas?.requestRenderAll()),this.dispatchEvent(new CustomEvent("text-modified",{detail:{element:t,property:"lineHeight",value:e}})))}setTextHeight(e){const t=this.getActiveTextElement();t&&(t instanceof s?t.setHeight(e):(t.set("height",e),this.canvas?.requestRenderAll()),this.dispatchEvent(new CustomEvent("text-modified",{detail:{element:t,property:"height",value:e}})))}setTextWidth(e){const t=this.getActiveTextElement();t&&(t instanceof s?t.setWidth(e):(t.set("width",e),this.canvas?.requestRenderAll()),this.dispatchEvent(new CustomEvent("text-modified",{detail:{element:t,property:"width",value:e}})))}getTextStyles(){const e=this.getActiveTextElement();return e?{fontSize:e.fontSize,fontFamily:e.fontFamily,color:e.fill,bold:"bold"===e.fontWeight,italic:"italic"===e.fontStyle,textAlign:e.textAlign,lineHeight:e.lineHeight,height:e.height,width:e.width}:null}setImageSrc(e){const t=this.getActiveImageElement();t?t.setSrc?t.setSrc(e):console.warn("Image element does not support setSrc method"):console.warn("No image element selected")}setImageVariable(e){const t=this.getActiveImageElement();if(t)if(t.setVariableName)t.setVariableName(e);else{const t=`{{${e}}}`;this.setImageSrc(t)}else console.warn("No image element selected")}setImageOpacity(e){const t=this.getActiveImageElement();t&&t.setOpacity(e)}setImageWidth(e){const t=this.getActiveImageElement();t&&t.setWidth(e)}setImageHeight(e){const t=this.getActiveImageElement();t&&t.setHeight(e)}getImageProperties(){const e=this.getActiveImageElement();return e?e.getHostProperties?e.getHostProperties():{id:e.id||e.oUID,type:"image",left:e.left,top:e.top,width:e.getScaledWidth(),height:e.getScaledHeight(),scaleX:e.scaleX,scaleY:e.scaleY,angle:e.angle,opacity:e.opacity,src:e.getSrc()}:null}}class r{constructor(){this.standardFonts={helvetica:"Helvetica","helvetica-bold":"Helvetica-Bold","helvetica-oblique":"Helvetica-Oblique","helvetica-boldoblique":"Helvetica-BoldOblique","times-roman":"Times-Roman","times-bold":"Times-Bold","times-italic":"Times-Italic","times-bolditalic":"Times-BoldItalic",courier:"Courier","courier-bold":"Courier-Bold","courier-oblique":"Courier-Oblique","courier-boldoblique":"Courier-BoldOblique",symbol:"Symbol",zapfdingbats:"ZapfDingbats"},this.fontMappings={arial:"Helvetica",helvetica:"Helvetica","helvetica neue":"Helvetica",times:"Times-Roman","times new roman":"Times-Roman",courier:"Courier","courier new":"Courier",verdana:"Helvetica",georgia:"Times-Roman",palatino:"Times-Roman",garamond:"Times-Roman",bookman:"Times-Roman","trebuchet ms":"Helvetica",impact:"Helvetica-Bold",tahoma:"Helvetica",monaco:"Courier",consolas:"Courier"},this.customFonts=new Map,this.embeddedFontCache=new Map,this.fontkitRegistered=!1,this.fontCategories={"sans-serif":["Helvetica","Arial","Verdana","Tahoma","Trebuchet MS"],serif:["Times-Roman","Times New Roman","Georgia","Palatino","Garamond"],monospace:["Courier","Courier New","Monaco","Consolas"],decorative:["Impact","Symbol","ZapfDingbats"],custom:[]}}async registerFont(e,t){if(!e||!t)throw new Error("Font family name and font data are required");const a=e.toLowerCase(),i={family:e,fallback:t.fallback||"Helvetica",category:t.category||"custom",variants:{regular:null,bold:null,italic:null,boldItalic:null},loaded:!1,loading:!1,metadata:{dateAdded:new Date,source:"string"==typeof t.regular?"url":"buffer",hasVariants:!!(t.bold||t.italic||t.boldItalic)}};this.customFonts.set(a,i),"custom"===i.category?this.fontCategories.custom.push(e):this.fontCategories[i.category]?this.fontCategories[i.category].push(e):this.fontCategories[i.category]=[e],this.loadFontData(a,t),console.log(`Registered font family: ${e}`)}async loadFontData(e,t){const a=this.customFonts.get(e);if(a)try{t.regular&&(a.variants.regular=await this.loadFontVariant(t.regular)),t.bold&&(a.variants.bold=await this.loadFontVariant(t.bold)),t.italic&&(a.variants.italic=await this.loadFontVariant(t.italic)),t.boldItalic&&(a.variants.boldItalic=await this.loadFontVariant(t.boldItalic)),a.loaded=!0,console.log(`Loaded font data for ${e}`)}catch(t){console.error(`Error loading font data for ${e}:`,t),a.loaded=!1}}async loadFontVariant(e){if(e instanceof ArrayBuffer)return e;if("string"==typeof e)try{const t=await fetch(e);if(!t.ok)throw new Error(`Failed to fetch font: ${t.statusText}`);return await t.arrayBuffer()}catch(e){throw console.error("Error fetching font:",e),e}throw new Error("Invalid font source. Must be URL string or ArrayBuffer")}getStandardFont(e,t=!1,a=!1){if(!e)return"Helvetica";const i=e.toLowerCase();let s=this.fontMappings[i]||"Helvetica";return"Helvetica"===s?t&&a?"Helvetica-BoldOblique":t?"Helvetica-Bold":a?"Helvetica-Oblique":"Helvetica":"Times-Roman"===s?t&&a?"Times-BoldItalic":t?"Times-Bold":a?"Times-Italic":"Times-Roman":"Courier"===s?t&&a?"Courier-BoldOblique":t?"Courier-Bold":a?"Courier-Oblique":"Courier":"Helvetica"}async embedFont(e,t,a={}){const{bold:i=!1,italic:s=!1,fontkitInstance:n=null}=a;if(console.log(`ðŸ” FontManager: Embedding font ${t}, bold: ${i}, italic: ${s}`),n&&!this.fontkitRegistered)try{"function"==typeof e.registerFontkit?(e.registerFontkit(n),this.fontkitRegistered=!0,console.log("âœ… FontKit registered successfully")):console.warn("âš ï¸ pdfDoc.registerFontkit is not available")}catch(e){console.error("âŒ Error registering fontkit:",e)}const o=(t||"").toLowerCase(),r=`${o}:${i}:${s}`;if(this.embeddedFontCache.has(r))return console.log(`ðŸ“‹ Using cached font for ${r}`),this.embeddedFontCache.get(r);if(console.log(`ðŸ” Looking for custom font: "${o}"`),console.log("ðŸ“ Available custom fonts:",Array.from(this.customFonts.keys())),this.customFonts.has(o)){const a=this.customFonts.get(o);if(console.log(`âœ… Found custom font entry for "${o}":`,{loaded:a.loaded,loading:a.loading,hasRegular:!!a.variants.regular,hasBold:!!a.variants.bold,hasItalic:!!a.variants.italic,hasBoldItalic:!!a.variants.boldItalic}),!a.loaded)return console.warn(`âš ï¸ Font ${t} is registered but not loaded, using fallback: ${a.fallback}`),this.embedStandardFont(e,a.fallback,i,s);let n=null,l="regular";if(i&&s&&a.variants.boldItalic?(n=a.variants.boldItalic,l="boldItalic"):i&&a.variants.bold?(n=a.variants.bold,l="bold"):s&&a.variants.italic?(n=a.variants.italic,l="italic"):a.variants.regular&&(n=a.variants.regular,l="regular"),console.log(`ðŸŽ¯ Selected variant: ${l} for ${t}`),console.log("ðŸ“Š Font data info:",{available:!!n,type:n?n.constructor.name:"null",size:n?n.byteLength:0,isArrayBuffer:n instanceof ArrayBuffer,fontkitRegistered:this.fontkitRegistered}),n&&n.byteLength>0){if(!this.fontkitRegistered)return console.error(`âŒ FontKit not registered, cannot embed custom font ${t}`),console.log(`ðŸ”„ Falling back to standard font: ${a.fallback}`),this.embedStandardFont(e,a.fallback,i,s);try{console.log(`ðŸš€ Attempting to embed custom font ${t} (${l})`);let a=n;if(!(n instanceof ArrayBuffer)){if(console.log("ðŸ”„ Converting font data to ArrayBuffer..."),!(n instanceof Uint8Array))throw new Error(`Invalid font data type: ${n.constructor.name}`);a=n.buffer.slice(n.byteOffset,n.byteOffset+n.byteLength)}const i=await e.embedFont(a);return this.embeddedFontCache.set(r,i),console.log(`âœ… Successfully embedded custom font ${t} (${l})`),console.log("ðŸ“‹ Font name in PDF:",i.name),i}catch(e){console.error(`âŒ Error embedding custom font ${t}:`,e),console.log(`ðŸ”„ Falling back to standard font: ${a.fallback}`)}}else console.warn(`âš ï¸ No font data available for ${t}, using fallback: ${a.fallback}`);return this.embedStandardFont(e,a.fallback,i,s)}return console.log(`ðŸ“ Using standard font for ${t}`),this.embedStandardFont(e,t,i,s)}async embedStandardFont(e,t,a,i){const s=this.getStandardFont(t,a,i),n=await e.embedFont(s),o=`${t.toLowerCase()}:${a}:${i}`;return this.embeddedFontCache.set(o,n),n}getRegisteredFontFamilies(){return[...Object.keys(this.standardFonts),...Array.from(this.customFonts.keys())]}isFontAvailable(e){const t=(e||"").toLowerCase();return void 0!==this.standardFonts[t]||void 0!==this.fontMappings[t]||this.customFonts.has(t)}clearCaches(){this.embeddedFontCache.clear()}isStandardFont(e){const t=(e||"").toLowerCase();return void 0!==this.standardFonts[t]||void 0!==this.fontMappings[t]}getFontsByCategory(){const e={};for(const[t,a]of Object.entries(this.fontCategories))e[t]=[...a];for(const[t,a]of this.customFonts.entries()){const t=a.family,i=a.category||"custom";e[i]||(e[i]=[]),e[i].includes(t)||e[i].push(t)}for(const[t,a]of Object.entries(this.standardFonts)){let t="sans-serif";a.includes("Times")?t="serif":a.includes("Courier")?t="monospace":"Symbol"!==a&&"ZapfDingbats"!==a||(t="decorative"),e[t].includes(a)||e[t].push(a)}for(const t in e)e[t].sort();return e}getFontDetails(){const e=[];for(const[t,a]of Object.entries(this.standardFonts)){let t="sans-serif";a.includes("Times")?t="serif":a.includes("Courier")?t="monospace":"Symbol"!==a&&"ZapfDingbats"!==a||(t="decorative"),e.push({family:a,type:"standard",category:t,variants:this.getStandardFontVariants(a),isLoaded:!0,requiresFontkit:!1})}for(const[t,a]of Object.entries(this.fontMappings))if(Object.values(this.standardFonts).includes(a)&&!e.some((e=>e.family.toLowerCase()===t))){let i="sans-serif";a.includes("Times")?i="serif":a.includes("Courier")&&(i="monospace"),e.push({family:t,displayName:this.toTitleCase(t),type:"mapped",mapsTo:a,category:i,variants:this.getStandardFontVariants(a),isLoaded:!0,requiresFontkit:!1})}for(const[t,a]of this.customFonts.entries())e.push({family:a.family,type:"custom",category:a.category||"custom",variants:{regular:null!==a.variants.regular,bold:null!==a.variants.bold,italic:null!==a.variants.italic,boldItalic:null!==a.variants.boldItalic},isLoaded:a.loaded,isLoading:a.loading,fallback:a.fallback,metadata:a.metadata,requiresFontkit:!0});return e.sort(((e,t)=>e.family.localeCompare(t.family))),e}getStandardFontVariants(e){const t={regular:!1,bold:!1,italic:!1,boldItalic:!1};return"Helvetica"!==e&&"Times-Roman"!==e&&"Courier"!==e||(t.regular=!0),e.includes("Bold")&&e.includes("Oblique")||e.includes("Bold")&&e.includes("Italic")?t.boldItalic=!0:e.includes("Bold")?t.bold=!0:(e.includes("Oblique")||e.includes("Italic"))&&(t.italic=!0),("Helvetica"===e||"Times-Roman"===e||"Courier"===e)&&(t.bold=!0,t.italic=!0,t.boldItalic=!0),t}toTitleCase(e){return e.replace(/\w\S*/g,(function(e){return e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()}))}getAllFonts(){return[...Object.values(this.standardFonts),...Array.from(this.customFonts.values()).map((e=>e.family))].sort()}getReadyFonts(){return[...Object.values(this.standardFonts),...Array.from(this.customFonts.values()).filter((e=>e.loaded)).map((e=>e.family))].sort()}isFontReady(e){const t=(e||"").toLowerCase();if(this.isStandardFont(t))return!0;const a=this.customFonts.get(t);return a&&a.loaded}getFontStatus(e){const t=(e||"").toLowerCase();if(this.isStandardFont(t))return{family:e,status:"ready",type:"standard",requiresFontkit:!1};const a=this.customFonts.get(t);return a?{family:a.family,status:a.loaded?"ready":a.loading?"loading":"pending",type:"custom",fallback:a.fallback,requiresFontkit:!0}:null}}class l{constructor(e){this.pdfEditor=e,this.placeholders=new Map,this.currentData={},this.regex=/\{\{\s*([a-zA-Z0-9_:-]+)\s*\}\}/g,this._setupEventListeners()}_setupEventListeners(){this.pdfEditor.addEventListener("canvas-ready",(()=>{this._setupCanvasEventListeners()})),this.pdfEditor.addEventListener("text-changed",(e=>{this._analyzeTextForPlaceholders(e.detail.element)})),this.pdfEditor.addEventListener("text-modified",(e=>{this._analyzeTextForPlaceholders(e.detail)})),this.pdfEditor.addEventListener("image:changed",(e=>{this._analyzeImageForPlaceholders(e.detail,e.detail.data)})),this.pdfEditor.addEventListener("element-removed",(e=>{this._handleElementRemoval(e.detail)})),this.pdfEditor.addEventListener("page-rendered",(()=>{this._updatePlaceholderStyles()}))}_setupCanvasEventListeners(){const e=this.pdfEditor.elementManager.canvas;e?(console.log("Setting up Fabric.js event listeners in PlaceholderManager"),e.on("object:added",(e=>{this._handleObjectAdded(e.target)})),e.on("text:changed",(e=>{console.log("PlaceholderManager: texT:changed event",e.target),this._analyzeTextForPlaceholders(e.target)}))):console.warn("Canvas not available for PlaceholderManager event listeners")}_handleObjectAdded(e){if("i-text"===e.type||"text"===e.type)this._analyzeTextForPlaceholders(e);else if("image"===e.type)e.data?.isVariable&&this._analyzeImageForPlaceholders(e,e.data);else{if(e.data?.isGridLine||e.data?.isAlignmentGuide)return void console.log("Ignoring grid/guide element");console.log("Other object type added:",e.type)}this.pdfEditor.dispatchEvent(new CustomEvent("placeholder:object-added",{detail:{object:e}}))}_analyzeTextForPlaceholders(e){if(console.log(`[PH-ANALYZE] ðŸ” ANALYZING text element: ${e.id} - "${e.text}"`),console.log("[PH-ANALYZE] ðŸ“ Element data:",e.data),!e||!e.text)return void console.log("[PH-ANALYZE] âŒ Invalid text element or empty text");const t=e.data?.pageNumber||this.pdfEditor.currentPage,a=e.id||Date.now().toString(),i=e.text;console.log(`[PH-ANALYZE] ðŸ“ Processing: id=${a}, page=${t}, text="${i}"`);const s=Array.from(i.matchAll(this.regex));if(console.log("ðŸ“ Text matches found:",s.length),e.data||(e.data={}),0===s.length)return e.data.originalText?(this._removePlaceholder(a,t),void console.log("ðŸ”„ Removed from tracking but preserved original metadata for future restoration")):void console.log("ðŸ§¹ Element never had variables, no cleanup needed");const n=s.map((e=>({variable:e[1],full:e[0],index:e.index,length:e[0].length})));console.log("ðŸ“Š Text variables extracted:",n),e.data.originalText=i,e.data.variableInfo=n,e.data.hasVariables=!0,e.data.pageNumber=t,console.log("ðŸ’¾ Stored variable metadata on text element:",{id:a,originalText:i,variableCount:n.length}),this._savePlaceholder(a,t,{element:e,elementType:"text",variables:n,text:i}),this._stylePlaceholder(e,n),Object.keys(this.currentData).length>0&&this._applyCurrentDataToElement(e)}_analyzeImageForPlaceholders(e,t){if(console.log("ðŸ” Analyzing image for placeholders:",t),!e||!t)return;const a=e.data?.pageNumber||this.pdfEditor.currentPage,i=e.id||e.oUID||Date.now().toString();if(e.data||(e.data={}),!t.isVariable||!t.variableName)return delete e.data.originalSrc,delete e.data.variableInfo,delete e.data.isVariable,delete e.data.variableName,this._removePlaceholder(i,a),void console.log("ðŸ§¹ Cleaned variable metadata from image element");const s=[{variable:t.variableName,full:`{{${t.variableName}}}`,index:0,length:t.variableName.length+4}];console.log("ðŸ“Š Image variables extracted:",s),e.data.originalSrc=t.originalSrc||e.src,e.data.variableInfo=s,e.data.isVariable=!0,e.data.variableName=t.variableName,e.data.pageNumber=a,console.log("ðŸ’¾ Stored variable metadata on image element:",{id:i,variableName:t.variableName,originalSrc:e.data.originalSrc}),this._savePlaceholder(i,a,{element:e,elementType:"image",variables:s,originalSrc:t.originalSrc}),Object.keys(this.currentData).length>0&&this._applyCurrentDataToElement(e)}_savePlaceholder(e,t,a){console.log(`[PH-SAVE] ðŸ’¾ SAVING placeholder: ${e} on page ${t}, type: ${a.elementType}`),console.log("[PH-SAVE] ðŸ“Š Total placeholders before:",this.placeholders.size,"pages"),this.placeholders.has(t)||(this.placeholders.set(t,new Map),console.log(`[PH-SAVE] ðŸ†• Created new page map for page ${t}`));const i=this.placeholders.get(t);console.log(`[PH-SAVE] ðŸ“ Page ${t} had ${i.size} placeholders before adding`),i.set(e,a),console.log(`[PH-SAVE] âœ… Page ${t} now has ${i.size} placeholders after adding`),console.log("[PH-SAVE] ðŸ“Š Total placeholders after:",this.placeholders.size,"pages"),this._dispatchPlaceholdersUpdated()}_removePlaceholder(e,t){if(console.log(`[PH-REMOVE] ðŸ—‘ï¸ ATTEMPTING to remove placeholder: ${e} on page ${t}`),!this.placeholders.has(t))return void console.log(`[PH-REMOVE] âŒ No placeholders found for page ${t}`);const a=this.placeholders.get(t);console.log(`[PH-REMOVE] ðŸ“ Page ${t} has ${a.size} placeholders before removal`),a.has(e)?(console.log(`[PH-REMOVE] âœ… Found element ${e}, removing from tracking`),a.delete(e),console.log(`[PH-REMOVE] ðŸ“ Page ${t} now has ${a.size} placeholders after removal`),this._dispatchPlaceholdersUpdated()):console.log(`[PH-REMOVE] âŒ Element ${e} not found in page ${t} placeholders`)}_handleElementRemoval(e){if(!e||!e.id&&!e.oUID)return;const t=e.id||e.oUID;for(const[e,a]of this.placeholders.entries())a.has(t)&&a.delete(t);this._cleanElementMetadata(e),this._dispatchPlaceholdersUpdated()}_cleanElementMetadata(e){e?.data&&(console.log(`ðŸ§¹ Cleaning metadata from deleted element: ${e.id}`),delete e.data.originalText,delete e.data.variableInfo,delete e.data.hasVariables,delete e.data.originalSrc,delete e.data.isVariable,delete e.data.variableName)}_stylePlaceholder(e,t){const a=this.pdfEditor.elementManager.canvas;a&&("image"===e.type&&console.log("Image variable styling already applied by ImageElement"),a.renderAll())}_updatePlaceholderStyles(){const e=this.pdfEditor.currentPage;if(!this.placeholders.has(e))return;const t=this.pdfEditor.elementManager.canvas;if(!t)return;const a=this.placeholders.get(e);for(const[e,i]of a.entries()){const a=t.getObjects().find((t=>t.id===e||t.oUID===e));a&&this._stylePlaceholder(a,i.variables)}}_dispatchPlaceholdersUpdated(){const e=new Set;for(const[t,a]of this.placeholders.entries())for(const[t,i]of a.entries())i.variables.forEach((t=>e.add(t.variable)));this.pdfEditor.dispatchEvent(new CustomEvent("placeholders-updated",{detail:{variables:Array.from(e),placeholders:this.placeholders}}))}getAllVariables(){const e=new Set;for(const[t,a]of this.placeholders.entries())for(const[t,i]of a.entries())i.variables.forEach((t=>e.add(t.variable)));return Array.from(e)}getTextVariables(){return this.getAllVariables().filter((e=>!e.startsWith("image:")))}getImageVariables(){return this.getAllVariables().filter((e=>e.startsWith("image:")))}_applyCurrentDataToElement(e){e?.data&&(e.data.hasVariables&&e.data.variableInfo?this._applyDataToTextElementUsingMetadata(e):e.data.isVariable&&e.data.variableName&&this._applyDataToImageElementUsingMetadata(e))}_applyDataToTextElementUsingMetadata(e){if(!e.data?.hasVariables||!e.data.variableInfo)return;let t=e.data.originalText,a=!1;e.data.variableInfo.forEach((e=>{if(this.currentData.hasOwnProperty(e.variable)){const i=this.currentData[e.variable];t=t.replace(e.full,i),a=!0,console.log(`ðŸ”„ Applied ${e.variable} = "${i}" to text element`)}})),a&&e.set("text",t)}async _applyDataToImageElementUsingMetadata(e){if(!e.data?.isVariable||!e.data.variableName)return;const t=e.data.variableName;if(this.currentData.hasOwnProperty(t)){const a=this.currentData[t];e.applyVariableData&&(await e.applyVariableData(a,!1),console.log(`ðŸ”„ Applied ${t} to image element`))}}async applyData(e,t=!0){console.log("ðŸ”§ Applying data using element metadata:",e,"Preview:",t),this.currentData={...this.currentData,...e};const a=[];for(const[e,t]of this.placeholders)for(const[e,i]of t){const e=i.element;if(e)if("text"===i.elementType)this._applyDataToTextElementUsingMetadata(e);else if("image"===i.elementType){const t=this._applyDataToImageElementUsingMetadata(e);a.push(t)}}a.length>0&&await Promise.all(a),this.pdfEditor.elementManager?.canvas&&this.pdfEditor.elementManager.canvas.requestRenderAll(),console.log("âœ… Data application completed using element metadata")}async clearData(){console.log("ðŸ§¹ Clearing all variable data (hybrid approach)"),this.currentData={};const e=[],t=new Set;console.log("PlaceHolder test: ",this.placeholders);const a=this.placeholders.get(this.pdfEditor.currentPage);if(a)for(const[i,s]of a){const a=s.element;if(a)if(t.add(i),"text"===s.elementType)this._restoreTextElementToOriginal(a);else if("image"===s.elementType){const t=this._restoreImageElementToOriginal(a);e.push(t)}}const i=this.pdfEditor.elementManager?.canvas;if(i){console.log("ðŸ” Checking current page canvas elements for untracked variable metadata...");const a=i.getObjects();for(const i of a)if(!(t.has(i.id)||i.data?.isGridLine||i.data?.isAlignmentGuide))if(i.data?.hasVariables&&i.data?.originalText)console.log(`ðŸ”„ Found untracked text element with metadata: ${i.id}`),this._restoreTextElementToOriginal(i),this._analyzeTextForPlaceholders(i);else if(i.data?.isVariable&&i.data?.variableName){console.log(`ðŸ”„ Found untracked image element with metadata: ${i.id}`);const t=this._restoreImageElementToOriginal(i);e.push(t),this._analyzeImageForPlaceholders(i,i.data)}}e.length>0&&await Promise.all(e),i&&i.requestRenderAll(),console.log("âœ… Current page cleared immediately. Other pages will be cleared when visited (hybrid approach)")}_restoreTextElementToOriginal(e){e.data?.hasVariables&&e.data.originalText&&(e.set("text",e.data.originalText),console.log(`ðŸ”„ Restored text element to original: "${e.data.originalText}"`))}async _restoreImageElementToOriginal(e){if(e.data?.isVariable&&e.data.originalSrc)try{e.clearVariableData?await e.clearVariableData():e.setSrc(e.data.originalSrc),console.log("ðŸ”„ Restored image element to original src")}catch(e){console.error("Error restoring image element:",e)}}async _applyDataToCurrentPage(){const e=this.pdfEditor.currentPage;if(!this.placeholders.has(e))return;const t=this.pdfEditor.elementManager.canvas;if(!t)return;const a=this.placeholders.get(e),i=[];for(const[e,s]of a.entries()){console.log("==============,,,",e,s);const a=t.getObjects().find((t=>t.id===e||t.oUID===e));if(console.log("-----",a),console.log("wow",t.getObjects()),a)if("text"===s.elementType)this._applyDataToTextElement(a,s);else if("image"===s.elementType){const e=this._applyDataToImageElement(a,s);e&&"function"==typeof e.then&&i.push(e)}}i.length>0&&await Promise.all(i)}_applyDataToTextElement(e,t){let a=t.text;t.variables.forEach((e=>{if(this.currentData.hasOwnProperty(e.variable)){const t=this.currentData[e.variable]||"";a=a.replace(e.full,t)}})),e.set("text",a),this.pdfEditor.elementManager.canvas.renderAll()}_applyDataToImageElement(e,t){console.log("applying dybmaic data ",e);const a=t.variables[0];if(console.log("ðŸ› BULK_IMAGE_DEBUG Variable:",{variableName:a.variable,currentData:this.currentData,hasProperty:this.currentData.hasOwnProperty(a.variable),dataKeys:Object.keys(this.currentData)}),this.currentData.hasOwnProperty(a.variable)){const t=this.currentData[a.variable];if(console.log("ðŸ› BULK_IMAGE_DEBUG Image URL found:",t),t&&e.applyVariableData)return e.applyVariableData(t,!0)}else console.log("ðŸ› BULK_IMAGE_DEBUG Image variable not found in data:",a.variable),e.clearVariableData&&e.clearVariableData();return Promise.resolve()}processTextForPDF(e){return e?e.replace(this.regex,((e,t)=>this.currentData.hasOwnProperty(t)?this.currentData[t]:e)):e}processImageForPDF(e,t){if(!e||!t)return e;if(console.log("ðŸ› BULK_IMAGE_DEBUG processImageForPDF:",{src:e,variableName:t,currentData:this.currentData,hasProperty:this.currentData.hasOwnProperty(t),dataKeys:Object.keys(this.currentData)}),this.currentData.hasOwnProperty(t)){const e=this.currentData[t];return console.log("ðŸ› BULK_IMAGE_DEBUG Found image URL:",e),e}return console.log("ðŸ› BULK_IMAGE_DEBUG Variable not found, returning original src"),e}validateVariables(e={}){const t=this.getAllVariables(),a=[],i=[];return t.forEach((t=>{e.hasOwnProperty(t)?i.push(t):a.push(t)})),{isValid:0===a.length,total:t.length,available:i.length,missing:a.length,missingVariables:a,availableVariables:i}}}class d{constructor(e){this.pdfEditor=e,this._hasUnsavedChanges=!1,this._changeListeners=new Set,this.setupChangeTracking()}setupChangeTracking(){this.pdfEditor.elementManager.addEventListener("elements-moved",(()=>{this.markAsModified()})),this.pdfEditor.elementManager.addEventListener("text-changed",(()=>{this.markAsModified()})),this.pdfEditor.elementManager.addEventListener("element-added",(()=>{this.markAsModified()})),this.pdfEditor.elementManager.addEventListener("element-removed",(()=>{this.markAsModified()})),this.pdfEditor.elementManager.addEventListener("selection-changed",(()=>{this.markAsModified()})),this.pdfEditor.elementManager.addEventListener("z-index-changed",(()=>{this.markAsModified()}))}markAsModified(){this._hasUnsavedChanges||(this._hasUnsavedChanges=!0,this.pdfEditor.dispatchEvent(new CustomEvent("document-modified",{detail:{timestamp:(new Date).toISOString()}})))}markAsSaved(){this._hasUnsavedChanges=!1,this.pdfEditor.dispatchEvent(new CustomEvent("document-saved",{detail:{timestamp:(new Date).toISOString()}}))}hasUnsavedChanges(){return this._hasUnsavedChanges}getCompleteState(){this.pdfEditor.currentPage&&this.pdfEditor.saveCurrentPageElements();return{metadata:{pageCount:this.pdfEditor.pageCount,currentPage:1,zoom:this.pdfEditor.zoom,isPDFLoaded:this.pdfEditor.isPDFLoaded,timestamp:(new Date).toISOString(),version:"1.0",pdfPageCount:this.pdfEditor.pdfPageCount,blankPageCount:this.pdfEditor.blankPageCount,hasUploadedPDF:this.pdfEditor.pdfPageCount>0,pdfInfo:this.pdfEditor.pdfInfo},grid:{showGrid:this.pdfEditor.showGrid,gridSize:this.pdfEditor.gridSize,gridColor:this.pdfEditor.gridColor,gridOpacity:this.pdfEditor.gridOpacity,snapToGrid:this.pdfEditor.snapToGrid},pages:this.getAllPagesData(),variables:this.getVariablesData(),fonts:this.getFontsData(),currentVariableData:this.pdfEditor.placeholderManager.currentData||{}}}getAllPagesData(){this.pdfEditor.currentPage&&this.pdfEditor.saveCurrentPageElements();const e={};for(let t=1;t<=this.pdfEditor.pageCount;t++){const a=(this.pdfEditor.pageElements[t]||[]).map((e=>{const t={...e};return"i-text"===e.type&&e.data?.originalText&&(t.text=e.data.originalText),"image"===e.type&&e.data?.originalSrc&&(t.src=e.data.originalSrc),t}));e[t]={elements:a,elementCount:a.length}}return e}getVariablesData(){const e=this.pdfEditor.getDocumentVariables(),t=this.pdfEditor.getTextVariables(),a=this.pdfEditor.getImageVariables();return{all:e,text:t,images:a,summary:{totalCount:e.length,textCount:t.length,imageCount:a.length,hasVariables:e.length>0},usageByPage:this.getVariableUsageByPage()}}getFontsData(){return{used:Array.from(this.pdfEditor.usedFonts),registered:this.pdfEditor.getRegisteredFonts(),missing:this.pdfEditor.getMissingFonts(),ready:this.pdfEditor.getReadyFonts()}}getVariableUsageByPage(){const e={};for(let t=1;t<=this.pdfEditor.pageCount;t++){const a=this.pdfEditor.pageElements[t]||[],i=new Set;a.forEach((e=>{if("i-text"===e.type&&e.text){this.extractVariablesFromText(e.text).forEach((e=>i.add(e)))}else"image"===e.type&&e.data?.isVariable&&i.add(e.data.variableName)})),e[t]=Array.from(i)}return e}extractVariablesFromText(e){if(!e)return[];const t=/\{\{([^}]+)\}\}/g,a=[];let i;for(;null!==(i=t.exec(e));)a.push(i[1].trim());return a}getStateSummary(){const e=Object.values(this.pdfEditor.pageElements).reduce(((e,t)=>e+t.length),0);return{pageCount:this.pdfEditor.pageCount,currentPage:1,totalElements:e,variableCount:this.pdfEditor.getDocumentVariables().length,hasUnsavedChanges:this.hasUnsavedChanges(),lastModified:(new Date).toISOString()}}getPDFGenerationData(){return this.pdfEditor.saveCurrentPageElements(),{pageElements:this.pdfEditor.pageElements,variables:this.pdfEditor.getDocumentVariables(),fonts:Array.from(this.pdfEditor.usedFonts),metadata:{pageCount:this.pdfEditor.pageCount,version:"1.0"}}}async restoreCompleteState(e){try{if(console.log("ðŸ”„ Restoring complete state from backend..."),!this.validateStateData(e))throw new Error("Invalid state data structure");return e.grid&&this.restoreGridSettings(e.grid),e.pages&&await this.restorePagesData(e.pages),e.fonts&&e.fonts.used&&await this.restoreFonts(e.fonts.used),e.currentVariableData&&Object.keys(e.currentVariableData).length>0&&this.pdfEditor.applyData(e.currentVariableData,!1),e.metadata&&e.metadata.currentPage?(this.pdfEditor._isRestoringState=!0,await this.pdfEditor.goToPage(e.metadata.currentPage),setTimeout((()=>{this.pdfEditor._isRestoringState=!1,console.log("ðŸ”“ State restoration flag cleared")}),500)):this.pdfEditor._isRestoringState=!1,this.markAsSaved(),console.log("âœ… State restoration completed successfully"),!0}catch(e){return console.error("âŒ Error restoring state:",e),this.pdfEditor.handleError(e),!1}}async restorePagesData(e){console.log("ðŸ”„ Restoring pages data..."),this.pdfEditor.pageElements={};for(const[t,a]of Object.entries(e)){const e=parseInt(t);console.log(`ðŸ” Restoring page ${e}, pageData:`,a),console.log("ðŸ” pageData.elements:",a.elements),this.pdfEditor.pageElements[e]=a.elements||[],console.log(`ðŸ“„ Restored ${a.elements?.length||0} elements for page ${e}`),console.log(`ðŸ” Final pageElements[${e}]:`,this.pdfEditor.pageElements[e])}this.pdfEditor.currentPage&&this.pdfEditor.pageElements[this.pdfEditor.currentPage]&&this.pdfEditor.loadPageElements(this.pdfEditor.currentPage)}restoreGridSettings(e){console.log("ðŸ”„ Restoring grid settings..."),this.pdfEditor.showGrid=e.showGrid||!1,this.pdfEditor.gridSize=e.gridSize||20,this.pdfEditor.gridColor=e.gridColor||"#666666",this.pdfEditor.gridOpacity=e.gridOpacity||.3,this.pdfEditor.snapToGrid=e.snapToGrid||!1,this.pdfEditor.showGrid&&this.pdfEditor.isCanvasReady()&&this.pdfEditor.renderGrid(),this.pdfEditor.snapToGrid&&this.pdfEditor.enableSnapToGrid()}async restoreFonts(e){console.log("ðŸ”„ Restoring fonts...",e),e.forEach((e=>{this.pdfEditor.usedFonts.add(e)})),await this.pdfEditor.verifyAndRequestMissingFonts()}validateStateData(e){if(!e||"object"!=typeof e)return console.error("State data must be an object"),!1;const t=["metadata","pages"];for(const a of t)if(!e[a])return console.error(`Missing required property: ${a}`),!1;return!(!e.metadata.pageCount||e.metadata.pageCount<1)||(console.error("Invalid page count in metadata"),!1)}exportStateAsJSON(e=!1){const t=this.getCompleteState();return JSON.stringify(t,null,e?2:0)}async importStateFromJSON(e){try{const t=JSON.parse(e);return await this.restoreCompleteState(t)}catch(e){return console.error("Error parsing JSON state:",e),!1}}createSavePayload(e,t={}){const a=this.getCompleteState();return{documentId:e,state:a,metadata:{...t,savedAt:(new Date).toISOString(),version:a.metadata.version,summary:this.getStateSummary()}}}createIncrementalSavePayload(e){const t=this.getCompleteState(),a=this.detectChanges(e,t);return{type:"incremental",timestamp:(new Date).toISOString(),changes:a,summary:this.getStateSummary()}}detectChanges(e,t){const a={pages:{},variables:!1,grid:!1,metadata:!1};for(let i=1;i<=t.metadata.pageCount;i++){const s=e?.pages?.[i],n=t.pages[i];JSON.stringify(s)!==JSON.stringify(n)&&(a.pages[i]=n)}return JSON.stringify(e?.variables)!==JSON.stringify(t.variables)&&(a.variables=t.variables),JSON.stringify(e?.grid)!==JSON.stringify(t.grid)&&(a.grid=t.grid),JSON.stringify(e?.metadata)!==JSON.stringify(t.metadata)&&(a.metadata=t.metadata),a}}class c{constructor(e,t){this.pdfEditor=e,this.elementManager=t,this.canvas=null,this.isEnabled=!0,this.config={icons:{delete:{position:{x:.5,y:-.5,offsetX:16,offsetY:-16},size:24,backgroundColor:"#dc3545",iconColor:"white",touchSize:32,render:this.renderDeleteIcon.bind(this)},copy:{position:{x:.5,y:-.5,offsetX:16,offsetY:-16},size:24,backgroundColor:"#007bff",iconColor:"white",touchSize:32,render:this.renderCopyIcon.bind(this)}},enabled:["delete","copy"],stackDirection:"vertical"},this.setupEventListeners()}initialize(e){this.canvas=e,this.setupFabricControls(),console.log("[ACTION-ICON-MANAGER] Initialized with Fabric controls")}setupFabricControls(){this.canvas&&(this.controls={},this.config.enabled.forEach(((e,t)=>{const a=this.config.icons[e];if(!a)return void console.warn(`[ACTION-ICON-MANAGER] No configuration found for icon: ${e}`);const i=this.calculateIconPosition(a.position,t),s=new fabric.Control({x:i.x,y:i.y,offsetX:i.offsetX,offsetY:i.offsetY,cursorStyle:"pointer",mouseUpHandler:this.getActionHandler(e),render:this.createIconRenderer(e,a),cornerSize:a.touchSize,touchSizeX:a.touchSize,touchSizeY:a.touchSize});this.controls[e]=s})),console.log("[ACTION-ICON-MANAGER] Fabric controls created:",Object.keys(this.controls)))}calculateIconPosition(e,t){let a={...e};return"vertical"===this.config.stackDirection?a.offsetY=e.offsetY-32*t:"horizontal"===this.config.stackDirection&&(a.offsetX=e.offsetX+32*t),a}getActionHandler(e){if(this.customHandlers&&this.customHandlers[e])return this.customHandlers[e];switch(e){case"delete":return this.deleteHandler.bind(this);case"copy":return this.copyHandler.bind(this);default:return console.warn(`[ACTION-ICON-MANAGER] No handler found for icon: ${e}`),()=>!1}}createIconRenderer(e,t){return(a,i,s,n,o)=>{t.render&&"function"==typeof t.render?t.render(a,i,s,n,o,t):this.renderDefaultIcon(a,i,s,t,e)}}setupEventListeners(){this.elementManager&&(this.elementManager.addEventListener("selection-created",(e=>{this.handleSelectionCreated(e.detail)})),this.elementManager.addEventListener("selection-cleared",(()=>{this.handleSelectionCleared()})),this.elementManager.addEventListener("selection-updated",(e=>{this.handleSelectionCreated(e.detail)})))}handleSelectionCreated(e){if(console.log("[ACTION-ICON-MANAGER] Selection created:",{isEnabled:this.isEnabled,hasSelected:!!e.selected,selectedCount:e.selected?.length,selectedElement:e.selected?.[0]?.id}),!this.isEnabled||!e.selected||1!==e.selected.length)return void this.removeControlsFromAllObjects();const t=e.selected[0];this.addControlsToElement(t)}handleSelectionCleared(){this.removeControlsFromAllObjects()}addControlsToElement(e){console.log("[ACTION-ICON-MANAGER] addControlsToElement called:",{hasElement:!!e,elementId:e?.id,hasDeleteControl:!!this.deleteControl,hasCopyControl:!!this.copyControl,elementHasControls:!!e?.controls}),e?(this.controls&&0!==Object.keys(this.controls).length||(console.log("[ACTION-ICON-MANAGER] Controls missing, recreating..."),this.setupFabricControls()),this.controls&&0!==Object.keys(this.controls).length?(this.removeControlsFromAllObjects(),e.controls={...e.controls,...this.controls},console.log("[ACTION-ICON-MANAGER] Controls added. Element controls:",Object.keys(e.controls)),e.setCoords(),this.canvas.requestRenderAll(),console.log("[ACTION-ICON-MANAGER] Added controls to element:",e.id)):console.log("[ACTION-ICON-MANAGER] Failed to create controls")):console.log("[ACTION-ICON-MANAGER] No element provided")}removeControlsFromAllObjects(){this.canvas&&(this.canvas.getObjects().forEach((e=>{e.controls&&this.config.enabled.forEach((t=>{delete e.controls[t]}))})),this.canvas.requestRenderAll())}renderDefaultIcon(e,t,a,i,s){const n=i.size;switch(e.save(),e.fillStyle=i.backgroundColor,e.beginPath(),e.arc(t,a,n/2,0,2*Math.PI),e.fill(),e.strokeStyle=i.iconColor,e.lineWidth=1.5,e.lineCap="round",s){case"delete":this.drawTrashIcon(e,t,a,n,i.iconColor);break;case"copy":this.drawCopyIcon(e,t,a,n,i.iconColor);break;default:this.drawDefaultIcon(e,t,a,n,i.iconColor)}e.restore()}drawTrashIcon(e,t,a,i,s){const n=.6*i,o=t-n/2,r=a-n/2;e.strokeStyle=s,e.fillStyle=s,e.lineWidth=Math.max(1,n/12),e.lineCap="round",e.lineJoin="round";const l=n/24,d=e=>e*l;e.save(),e.translate(o,r),e.beginPath(),e.moveTo(d(7),d(4)),e.lineTo(d(7),d(2)),e.quadraticCurveTo(d(7),d(1),d(8),d(1)),e.lineTo(d(16),d(1)),e.quadraticCurveTo(d(17),d(1),d(17),d(2)),e.lineTo(d(17),d(4)),e.moveTo(d(4),d(4)),e.lineTo(d(20),d(4)),e.quadraticCurveTo(d(21),d(4),d(21),d(5)),e.quadraticCurveTo(d(21),d(6),d(20),d(6)),e.lineTo(d(19),d(6)),e.lineTo(d(19),d(19)),e.quadraticCurveTo(d(19),d(21),d(17),d(21)),e.lineTo(d(7),d(21)),e.quadraticCurveTo(d(5),d(21),d(5),d(19)),e.lineTo(d(5),d(6)),e.lineTo(d(4),d(6)),e.quadraticCurveTo(d(3),d(6),d(3),d(5)),e.quadraticCurveTo(d(3),d(4),d(4),d(4)),e.fill(),e.globalCompositeOperation="destination-out",e.beginPath(),e.rect(d(7),d(8),d(10),d(11)),e.fill(),e.globalCompositeOperation="source-over",e.beginPath(),e.moveTo(d(9),d(9)),e.lineTo(d(9),d(17)),e.moveTo(d(12),d(9)),e.lineTo(d(12),d(17)),e.moveTo(d(15),d(9)),e.lineTo(d(15),d(17)),e.stroke(),e.restore()}drawCopyIcon(e,t,a,i,s){const n=.55*i;e.strokeStyle=s,e.fillStyle=s,e.lineWidth=Math.max(1.2,n/14),e.lineCap="round",e.lineJoin="round";const o=.55*n,r=.65*n,l=.15*n,d=.08*n,c=t-(o+l)/2,h=a-(r+l)/2;e.save(),e.fillStyle="transparent",e.beginPath(),e.roundRect(c,h,o,r,d),e.stroke(),e.fillStyle=s,e.beginPath(),e.roundRect(c+l,h+l,o,r,d),e.fill(),e.strokeStyle=s,e.stroke(),e.restore()}drawDefaultIcon(e,t,a,i,s){e.font=.6*i+"px Arial",e.fillStyle=s,e.textAlign="center",e.textBaseline="middle",e.fillText("?",t,a)}renderDeleteIcon(e,t,a,i,s,n){n?this.renderDefaultIcon(e,t,a,n,"delete"):this.renderDefaultIcon(e,t,a,{size:24,backgroundColor:"#dc3545",iconColor:"white"},"delete")}renderCopyIcon(e,t,a,i,s,n){n?this.renderDefaultIcon(e,t,a,n,"copy"):this.renderDefaultIcon(e,t,a,{size:24,backgroundColor:"#007bff",iconColor:"white"},"copy")}deleteHandler(e,t,a,i){const s=t.target;return!(!s||!this.canvas)&&(this.elementManager&&this.elementManager.removeElement?(console.log("[ACTION-ICON-MANAGER] Removing element via ElementManager"),this.elementManager.removeElement(s)):(console.warn("[ACTION-ICON-MANAGER] ElementManager not available, using direct canvas removal"),this.canvas.remove(s),this.canvas.requestRenderAll()),this.pdfEditor.dispatchEvent(new CustomEvent("element-deleted",{detail:{element:s}})),console.log("[ACTION-ICON-MANAGER] Element deleted via control"),!0)}copyHandler(e,t,a,i){const s=t.target;return!(!s||!this.canvas)&&(this.createProperClone(s,(e=>{e?(e.set({left:e.left+20,top:e.top+20,id:`${e.id}_copy_${Date.now()}`}),this.elementManager&&this.elementManager.addElement?(console.log("[ACTION-ICON-MANAGER] Adding properly cloned element via ElementManager"),this.elementManager.addElement(e),this.canvas&&(this.canvas.setActiveObject(e),this.canvas.requestRenderAll())):(console.warn("[ACTION-ICON-MANAGER] ElementManager not available, using direct canvas addition"),this.canvas.add(e),this.canvas.setActiveObject(e),this.canvas.requestRenderAll()),this.pdfEditor.dispatchEvent(new CustomEvent("element-copied",{detail:{original:s,copy:e}})),console.log("[ACTION-ICON-MANAGER] Element copied via control with proper type")):console.error("[ACTION-ICON-MANAGER] Failed to create proper clone")})),!0)}createProperClone(e,t){try{const a=this.getTextElementClass(),i=this.getImageElementClass();this.isTextElement(e)?(console.log("[ACTION-ICON-MANAGER] Cloning as TextElement"),this.cloneAsTextElement(e,a,t)):this.isImageElement(e)?(console.log("[ACTION-ICON-MANAGER] Cloning as ImageElement"),this.cloneAsImageElement(e,i,t)):(console.log("[ACTION-ICON-MANAGER] Cloning as generic fabric object"),e.clone(t))}catch(a){console.error("[ACTION-ICON-MANAGER] Error creating proper clone:",a),e.clone(t)}}cloneAsTextElement(e,t,a){if(!t)return console.warn("[ACTION-ICON-MANAGER] TextElement class not available, using regular clone"),void e.clone(a);try{const i=e.toObject();a(new t({...i,text:e.text,id:`${e.id}_copy_${Date.now()}`,data:e.data?{...e.data}:void 0}))}catch(t){console.error("[ACTION-ICON-MANAGER] Error cloning TextElement:",t),e.clone(a)}}cloneAsImageElement(e,t,a){if(!t)return console.warn("[ACTION-ICON-MANAGER] ImageElement class not available, using regular clone"),void e.clone(a);try{const i=e.toObject();a(new t(e.getElement(),{...i,src:e.getSrc?e.getSrc():i.src,id:`${e.id}_copy_${Date.now()}`,data:e.data?{...e.data}:void 0}))}catch(t){console.error("[ACTION-ICON-MANAGER] Error cloning ImageElement:",t),e.clone(a)}}isTextElement(e){return"i-text"===e.type||"text"===e.type||e.constructor&&"TextElement"===e.constructor.name}isImageElement(e){return"image"===e.type||e.constructor&&"ImageElement"===e.constructor.name}getTextElementClass(){try{return window.TextElement?window.TextElement:this.elementManager&&this.elementManager.TextElement?this.elementManager.TextElement:this.pdfEditor?.TextElement||null}catch(e){return console.warn("[ACTION-ICON-MANAGER] Could not get TextElement class:",e),null}}getImageElementClass(){try{return window.ImageElement?window.ImageElement:this.elementManager&&this.elementManager.ImageElement?this.elementManager.ImageElement:this.pdfEditor?.ImageElement||null}catch(e){return console.warn("[ACTION-ICON-MANAGER] Could not get ImageElement class:",e),null}}setEnabled(e){this.isEnabled=e,e||this.removeControlsFromAllObjects(),console.log("[ACTION-ICON-MANAGER] "+(e?"Enabled":"Disabled"))}configureControls(e){console.log("[ACTION-ICON-MANAGER] Configuring controls:",e),e.icons&&(this.config.icons={...this.config.icons,...e.icons},Object.keys(e.icons).forEach((t=>{this.config.icons[t]&&(this.config.icons[t]={...this.config.icons[t],...e.icons[t]},e.icons[t].render&&"function"==typeof e.icons[t].render&&(this.config.icons[t].render=e.icons[t].render.bind(this)))}))),e.enabled&&(this.config.enabled=e.enabled),e.stackDirection&&(this.config.stackDirection=e.stackDirection),this.setupFabricControls(),console.log("[ACTION-ICON-MANAGER] Controls configured successfully")}addCustomIcon(e,t,a){this.config.icons[e]={position:t.position||{x:.5,y:-.5,offsetX:16,offsetY:-16},size:t.size||24,backgroundColor:t.backgroundColor||"#6c757d",iconColor:t.iconColor||"white",touchSize:t.touchSize||32,render:t.render||this.renderDefaultIcon.bind(this)},this.config.enabled.includes(e)||this.config.enabled.push(e),this.customHandlers=this.customHandlers||{},this.customHandlers[e]=a,this.setupFabricControls(),console.log(`[ACTION-ICON-MANAGER] Custom icon '${e}' added`)}removeCustomIcon(e){delete this.config.icons[e],this.config.enabled=this.config.enabled.filter((t=>t!==e)),this.customHandlers&&delete this.customHandlers[e],this.setupFabricControls(),console.log(`[ACTION-ICON-MANAGER] Custom icon '${e}' removed`)}getConfiguration(){return JSON.parse(JSON.stringify(this.config))}destroy(){console.log("[ACTION-ICON-MANAGER] Destroy called"),this.removeControlsFromAllObjects(),this.canvas=null,this.deleteControl=null,this.copyControl=null,console.log("[ACTION-ICON-MANAGER] Destroyed")}}const h=`https://cdnjs.cloudflare.com/ajax/libs/pdf.js/${i.version}/pdf.worker.js`;class g extends e{static properties={currentPage:{type:Number,reflect:!0},pageCount:{type:Number,reflect:!0},zoom:{type:Number,reflect:!0},isPDFLoaded:{type:Boolean,reflect:!0},workerSrc:{type:String},isLoading:{type:Boolean,reflect:!0},error:{type:String,reflect:!0},isEditMode:{type:Boolean,reflect:!0},editorScale:{type:Number,state:!0},viewportOffset:{type:Object,state:!0},viewportScale:{type:Number,state:!0},selectedText:{type:Object,state:!0},showGrid:{type:Boolean,reflect:!0},gridSize:{type:Number,reflect:!0},gridColor:{type:String,reflect:!0},gridOpacity:{type:Number,reflect:!0},snapToGrid:{type:Boolean,reflect:!0},pageElements:{type:Object,state:!0}};static styles=t`
    :host {
      display: block;
      position: relative;
    }

    .pdf-container {
      position: relative;
      width: fit-content;
      height: fit-content;
    }

    .canvas-container {
      position: relative;
      width: fit-content;
      height: fit-content;
      background: transparent !important;
    }

    #pdf-canvas {
      position: absolute;
      top: 0;
      left: 0;
      z-index: 1;
    }

    .fabric-container {
      position: absolute;
      top: 0;
      left: 0;
      z-index: 2;
      background: transparent !important;
    }

    .edit-mode-indicator {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(33, 150, 243, 0.9);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      display: none;
      z-index: 3;
    }

    :host([isEditMode]) .edit-mode-indicator {
      display: block;
    }

    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 4;
    }

    .error-message {
      color: red;
      padding: 16px;
      text-align: center;
      border: 1px solid red;
      border-radius: 4px;
      margin: 16px;
      background: rgba(255, 0, 0, 0.1);
    }

    /* Debug styles */
    .upper-canvas {
      outline: 2px solid blue !important;
    }

    .lower-canvas {
      outline: 2px solid red !important;
    }

    /* Ensure the canvas container doesn't interfere with events */
    .canvas-container {
      position: relative !important;
      pointer-events: all !important;
    }

    /* Ensure Fabric.js generated elements receive events */
    .upper-canvas,
    .lower-canvas {
      pointer-events: all !important;
    }

    /* Ensure Fabric.js canvases are transparent */
    .upper-canvas,
    .lower-canvas {
      background: transparent !important;
      background-color: transparent !important;
    }

    /* Remove any background from canvas container */
    .canvas-container {
      background: transparent !important;
    }
  `;constructor(){super(),this.currentPage=1,this.pageCount=0,this.zoom=1,this.isPDFLoaded=!1,this.pdfDoc=null,this.workerSrc=null,this.isLoading=!1,this.error=null,this.isEditMode=!1,this.editorScale=1,this.editorContext=null,this.elementManager=new o,this.actionIconManager=new c(this,this.elementManager),this.TextElement=s,this.ImageElement=n,"undefined"!=typeof window&&(window.TextElement=s,window.ImageElement=n),this.placeholderManager=new l(this),this.setupElementManagerEventListeners(),this.viewportOffset={x:0,y:0},this.viewportScale=1,this.showGrid=!1,this.gridSize=20,this.gridColor="#666666",this.gridOpacity=.3,this.snapToGrid=!1,this.pageElements={},this.fontManager=new r,this.usedFonts=new Set,this.stateManager=new d(this),this.globalImagePlaceholder=null,this.pdfPageCount=0,this.blankPageCount=0,this.pdfInfo=null}setupElementManagerEventListeners(){this.elementManager.addEventListener("elements-moved",(()=>{this.dispatchEvent(new CustomEvent("elements-modified"))})),this.elementManager.addEventListener("selection-changed",(e=>{e.detail.isText?this.selectedText=e.detail.target:this.selectedText=null,this.dispatchEvent(new CustomEvent("selection-changed",{detail:e.detail}))})),this.elementManager.addEventListener("z-index-changed",(()=>{this.dispatchEvent(new CustomEvent("elements-modified"))})),this.elementManager.addEventListener("text-changed",(e=>{this.dispatchEvent(new CustomEvent("text-changed",{detail:e.detail}))})),this.elementManager.addEventListener("element-added",(e=>{this.dispatchEvent(new CustomEvent("element-added",{detail:e.detail}))})),this.elementManager.addEventListener("element-removed",(e=>{this.dispatchEvent(new CustomEvent("element-removed",{detail:e.detail}))}))}connectedCallback(){super.connectedCallback(),this.setupPDFWorker()}disconnectedCallback(){super.disconnectedCallback(),this.actionIconManager&&this.actionIconManager.destroy(),this.cleanup()}cleanup(){this.pdfDoc&&(this.pdfDoc.destroy(),this.pdfDoc=null);const e=this.renderRoot.querySelector("#pdf-canvas");if(e){e.getContext("2d").clearRect(0,0,e.width,e.height)}this.currentPage=1,this.pageCount=0,this.isPDFLoaded=!1,this.error=null,this.pdfPageCount=0,this.blankPageCount=0,this.pdfInfo=null}handleError(e){console.error("PDF Editor Error:",e),this.error=e.message,this.dispatchEvent(new CustomEvent("pdf-error",{detail:{error:e.message}}))}async setupPDFWorker(){if("undefined"!=typeof window&&"Worker"in window)try{if(this.workerSrc)i.GlobalWorkerOptions.workerSrc=this.workerSrc;else try{const e=new URL("pdfjs-dist/build/pdf.worker.mjs",import.meta.url);i.GlobalWorkerOptions.workerSrc=e.href}catch(e){i.GlobalWorkerOptions.workerSrc=h}}catch(e){this.handleError(new Error("Failed to initialize PDF worker"))}}async loadPDF(e){this.isLoading=!0,this.error=null;try{let t;if(await this.setupPDFWorker(),e instanceof File||e instanceof Blob)t=await e.arrayBuffer();else{if("string"!=typeof e)throw new Error("Invalid PDF source");{const a=await fetch(e);t=await a.arrayBuffer()}}this.cleanup(),this.pdfDoc=await i.getDocument(t).promise,this.pageCount=this.pdfDoc.numPages,this.isPDFLoaded=!0,this.pdfPageCount=this.pdfDoc.numPages,this.blankPageCount=0,this.pdfInfo={totalPages:this.pdfDoc.numPages},await this.renderPage(1),this.dispatchEvent(new CustomEvent("pdf-loaded",{detail:{pageCount:this.pageCount}}))}catch(e){this.handleError(e)}finally{this.isLoading=!1}}async renderPage(e){if(this.pdfDoc){this.currentPage&&!this._isRestoringState&&this.saveCurrentPageElements(),this.isLoading=!0,this.error=null;try{const t=await this.pdfDoc.getPage(e),a=this.renderRoot.querySelector("#pdf-canvas").getContext("2d"),i=t.getViewport({scale:this.zoom});this.syncCanvasDimensions(i.width,i.height),await t.render({canvasContext:a,viewport:i}).promise,this.currentPage=e,this.dispatchEvent(new CustomEvent("page-rendered",{detail:{pageNumber:e,width:i.width,height:i.height}})),this._isRestoringState?console.log(`ðŸ“‹ Skipping loadPageElements during state restoration for page ${e}`):await this.loadPageElements(e)}catch(e){this.handleError(e)}finally{this.isLoading=!1}}}async nextPage(){this.currentPage<this.pageCount&&await this.renderPage(this.currentPage+1)}async previousPage(){this.currentPage>1&&await this.renderPage(this.currentPage-1)}async goToPage(e){e>=1&&e<=this.pageCount&&await this.renderPage(e)}setZoom(e){this.zoom,this.zoom=Math.max(.25,Math.min(4,e)),this.pdfDoc&&this.renderPage(this.currentPage);const t=this.elementManager.canvas;t&&(t.setZoom(this.zoom),t.width,t.height,t.getCenter(),t.setViewportTransform([this.zoom,0,0,this.zoom,0,0]),t.requestRenderAll(),this.showGrid&&this.renderGrid())}zoomIn(){this.setZoom(1.2*this.zoom)}zoomOut(){this.setZoom(this.zoom/1.2)}getCurrentPageDimensions(){const e=this.renderRoot.querySelector("#pdf-canvas");return{width:e.width,height:e.height}}getState(){return{currentPage:this.currentPage,pageCount:this.pageCount,zoom:this.zoom,isPDFLoaded:this.isPDFLoaded,dimensions:this.getCurrentPageDimensions()}}renderEditorContent(){this.editorContext&&this.elementManager.render(this.editorContext)}syncCanvasDimensions(e,t){console.log("Syncing canvas dimensions:",{width:e,height:t,zoom:this.zoom});const a=this.renderRoot.querySelector(".canvas-container");a.style.width=`${e}px`,a.style.height=`${t}px`;const i=this.renderRoot.querySelector("#pdf-canvas");i.width=e,i.height=t,i.style.width=`${e}px`,i.style.height=`${t}px`;const s=this.elementManager.canvas;s&&(s.setDimensions({width:e,height:t},{cssOnly:!1}),s.setZoom(this.zoom),s.getCenter(),s.setViewportTransform([this.zoom,0,0,this.zoom,0,0]),this.showGrid&&this.renderGrid(),s.requestRenderAll())}render(){return a`
      <div class="pdf-container">
        ${this.error?a` <div class="error-message">${this.error}</div> `:""}

        <div class="canvas-container">
          <canvas id="pdf-canvas"></canvas>
          <div class="fabric-container">
            <canvas id="editor-canvas"></canvas>
          </div>
          <div class="edit-mode-indicator">Edit Mode</div>
        </div>

        ${this.isLoading?a` <div class="loading-overlay">Loading...</div> `:""}
      </div>
    `}handleEditorMouseDown(e){if(!this.isEditMode)return e.preventDefault(),!1}handleEditorMouseMove(e){if(!this.isEditMode)return e.preventDefault(),!1}handleEditorMouseUp(e){if(!this.isEditMode)return e.preventDefault(),!1}firstUpdated(){const e=this.renderRoot.querySelector("#editor-canvas");e.width=800,e.height=600;const t=new window.fabric.Canvas(e,{selection:!0,preserveObjectStacking:!0,backgroundColor:null,width:e.width,height:e.height,interactive:!0,enableRetinaScaling:!0,skipTargetFind:!1,isDrawingMode:!1,centeredScaling:!0,centeredRotation:!0,stopContextMenu:!0,transparentCorners:!0,preserveObjectStacking:!0});t.setBackgroundColor(null,t.renderAll.bind(t)),t.upperCanvasEl.style.backgroundColor="transparent",t.lowerCanvasEl.style.backgroundColor="transparent",t.selection=!0,t.interactive=!0,this.elementManager.initialize(t,this),this.actionIconManager.initialize(t),t.renderAll(),this.showGrid&&(console.log("Initializing grid"),this.renderGrid()),console.log("Dispatching canvas-ready event"),this.dispatchEvent(new CustomEvent("canvas-ready",{bubbles:!0,composed:!0}))}setViewportOffset(e,t){this.viewportOffset={x:e,y:t},this.updateViewport()}setViewportScale(e){this.viewportScale=e,this.updateViewport()}updateViewport(){if(!this.elementManager.canvas)return;const e=this.elementManager.canvas,t=this.zoom*this.viewportScale;e.setZoom(t),e.absolutePan({x:-this.viewportOffset.x,y:-this.viewportOffset.y})}addText(e,t={}){if(!this.isEditMode)return;const a=this.elementManager.canvas.getCenter();return t.fontFamily&&this.trackFontUsage(t.fontFamily),this.elementManager.addText({text:e,left:a.left,top:a.top,pageNumber:this.currentPage,...t})}setFontSize(e){console.log("PDFEditor: Setting font size:",e),this.elementManager.setFontSize(e)}setText(e){console.log("PDFEditor: Setting text:",e),this.elementManager.setText(e)}setFontFamily(e){console.log("PDFEditor: Setting font family:",e),this.trackFontUsage(e),this.elementManager.setFontFamily(e)}setTextColor(e){console.log("PDFEditor: Setting text color:",e),this.elementManager.setTextColor(e)}setTextBold(e){console.log("PDFEditor: Setting text bold:",e),this.elementManager.setTextBold(e)}setTextItalic(e){console.log("PDFEditor: Setting text italic:",e),this.elementManager.setTextItalic(e)}setTextAlign(e){console.log("PDFEditor: Setting text align:",e),this.elementManager.setTextAlign(e)}setLineHeight(e){console.log("PDFEditor: Setting line height:",e),this.elementManager.setLineHeight(e)}setTextHeight(e){this.elementManager.setTextHeight(e)}setTextWidth(e){this.elementManager.setTextWidth(e)}getTextStyles(){return this.elementManager.getTextStyles()}isTextSelected(){return this.elementManager.isTextSelected()}setTextUnderline(e){console.log("Text underline not implemented yet:",e)}setTextStrikethrough(e){console.log("Text strikethrough not implemented yet:",e)}setTextBackgroundColor(e){console.log("Text background color not implemented yet:",e)}setLetterSpacing(e){console.log("Letter spacing not implemented yet:",e)}setTextOpacity(e){console.log("Text opacity not implemented yet:",e)}removeText(){const e=this.elementManager.getActiveTextElement();this.elementManager.removeElement(e)}removeImage(){const e=this.elementManager.getActiveImageElement();this.elementManager.removeElement(e)}saveStylePreset(e,t){console.log("Style preset saving not implemented yet:",{name:e,styles:t})}applyStylePreset(e){console.log("Style preset application not implemented yet:",e)}undoStyleChange(){console.log("Style undo not implemented yet")}redoStyleChange(){console.log("Style redo not implemented yet")}isCanvasReady(){const e=this.elementManager.canvas,t=e&&e.getWidth()>0&&e.getHeight()>0;return console.log("Canvas ready check:",t),t}setGridVisibility(e){console.log("Setting grid visibility:",e),this.showGrid=e,this.isCanvasReady()?this.renderGrid():console.warn("Canvas not ready for grid rendering")}setGridSize(e){const t=Math.max(1,Math.min(1e3,Math.abs(e||10)));t!==e&&console.warn(`Grid size ${e} adjusted to ${t}`),this.gridSize=t,this.showGrid&&this.renderGrid()}setGridColor(e){this.gridColor=e,this.renderGrid()}setGridOpacity(e){this.gridOpacity=e,this.renderGrid()}setSnapToGrid(e){this.snapToGrid=e,e?this.enableSnapToGrid():this.disableSnapToGrid()}renderGrid(){const e=this.elementManager.canvas;if(!e)return;if(e.getObjects().filter((e=>e.data?.isGridLine)).forEach((t=>e.remove(t))),!this.showGrid)return void e.requestRenderAll();const t=Math.max(1,Math.abs(this.gridSize||10));if(t<1)return void console.warn("Grid size too small, using minimum size of 1");const a=e.getZoom(),i=e.viewportTransform,s=-i[4]/a,n=-i[5]/a,o=e.width/a,r=e.height/a,l=2*t,d=Math.floor((s-l)/t)*t,c=Math.ceil((s+o+l)/t)*t,h=Math.floor((n-l)/t)*t,g=Math.ceil((n+r+l)/t)*t,m=1e3,p=Math.abs(c-d)/t,u=Math.abs(g-h)/t;if(p>m||u>m)return void console.warn("Grid would create too many lines, skipping render");console.log("Rendering grid:",{gridSize:t,verticalLines:p,horizontalLines:u,viewportLeft:s,viewportTop:n,viewportWidth:o,viewportHeight:r,zoom:a});let f=0;for(let i=d;i<=c&&f<m;i+=t){const t=new fabric.Line([i,h,i,g],{stroke:"#666666",strokeWidth:1/a,opacity:.3,selectable:!1,evented:!1,excludeFromExport:!0,data:{isGridLine:!0}});e.add(t),f++}f=0;for(let i=h;i<=g&&f<m;i+=t){const t=new fabric.Line([d,i,c,i],{stroke:"#666666",strokeWidth:1/a,opacity:.3,selectable:!1,evented:!1,excludeFromExport:!0,data:{isGridLine:!0}});e.add(t),f++}e.getObjects().filter((e=>e.data?.isGridLine)).forEach((t=>{e.sendToBack(t)})),e.requestRenderAll()}enableSnapToGrid(){const e=this.elementManager.canvas;console.log("===","lol"),e&&(e.on("object:moving",(e=>{if(!this.snapToGrid)return;console.log("===","yaya");const t=e.target,a=this.gridSize;t.set({left:Math.round(t.left/a)*a,top:Math.round(t.top/a)*a}),this.snapToGrid&&"text"===t.type&&this.showSimpleAlignmentGuides(t)})),e.on("mouse:up",(()=>{this.removeAlignmentGuides()})))}showSimpleAlignmentGuides(e){const t=this.elementManager.canvas;if(!t||!e)return;this.removeAlignmentGuides();const a=e.left+e.width*e.scaleX/2,i=e.top+e.height*e.scaleY/2,s=t.width/2,n=t.height/2;if(Math.abs(a-s)<10){const e=new fabric.Line([s,0,s,t.height],{stroke:"#FF0000",opacity:.8,strokeWidth:1,strokeDashArray:[4,4],selectable:!1,evented:!1,data:{isAlignmentGuide:!0}});t.add(e),t.bringToFront(e)}if(Math.abs(i-n)<10){const e=new fabric.Line([0,n,t.width,n],{stroke:"#FF0000",opacity:.8,strokeWidth:1,strokeDashArray:[4,4],selectable:!1,evented:!1,data:{isAlignmentGuide:!0}});t.add(e),t.bringToFront(e)}t.requestRenderAll()}disableSnapToGrid(){const e=this.elementManager.canvas;e&&e.off("object:moving")}canvasInitialized(){const e=this.elementManager.canvas;if(!e)return!1;const t={width:e.getWidth(),height:e.getHeight(),zoom:this.zoom};return console.log("Canvas initialization check:",t),t.width>0&&t.height>0}removeAlignmentGuides(){const e=this.elementManager.canvas;if(!e)return;e.getObjects().filter((e=>e.data?.isAlignmentGuide)).forEach((t=>e.remove(t))),e.requestRenderAll()}addImage(e,t={}){return this.isEditMode?new Promise(((a,i)=>{const s=new FileReader;s.onload=e=>{const s=e.target.result,n=this.elementManager.canvas;this.elementManager.addImageFromDataUrl(s,{left:n.getCenter().left,top:n.getCenter().top,data:{pageNumber:this.currentPage},...t}).then((e=>a(e))).catch((e=>i(e)))},s.onerror=i,s.readAsDataURL(e)})):Promise.reject(new Error("Not in edit mode."))}handleImageUpload(e){const t=e.target.files[0];console.log("file",t),t&&(t.type.startsWith("image/")?(console.log("hmm"),this.addImage(t)):console.error("File is not an image"))}setImageOpacity(e){this.elementManager.setImageOpacity(e)}setImageWidth(e){this.elementManager.setImageWidth(e)}setImageHeight(e){this.elementManager.setImageHeight(e)}saveCurrentPageElements(){const e=this.elementManager.canvas;if(!e)return;const t=e.getObjects().filter((e=>!e.data?.isGridLine&&!e.data?.isAlignmentGuide));this.pageElements[this.currentPage]=t.map((e=>{const t=e.toObject(["data","id"]);return t.data=t.data||{},t.data.pageNumber=this.currentPage,t.data.id=t.id,"i-text"===t.type&&t.data?.originalText&&(t.text=t.data.originalText,console.log(`ðŸ“ Saving text element in template format: "${t.data.originalText}"`)),"image"===t.type&&t.data?.originalSrc&&(t.src=t.data.originalSrc,console.log(`ðŸ–¼ï¸ Saving image element in template format: "${t.data.originalSrc}"`)),t})),console.log(`Saved ${t.length} elements for page ${this.currentPage}`)}async loadPageElements(e){const t=Math.random().toString(36).substr(2,6);console.log(`ðŸ“‹ [LOAD-${t}] loadPageElements called for page ${e}`),console.log(`ðŸ“‹ [LOAD-${t}] Called from:`,(new Error).stack.split("\n")[2]);const a=this.elementManager.canvas;if(!a)return;a.getObjects().filter((e=>!e.data?.isGridLine&&!e.data?.isAlignmentGuide)).forEach((e=>a.remove(e))),this.pageElements[e]&&(console.log(`ðŸ“‹ [LOAD-${t}] Loading ${this.pageElements[e].length} elements for page ${e}`),this.pageElements[e].forEach((e=>{if("image"===e.type&&e.data?.isVariable){console.log("ðŸ”§ Recreating variable image directly:",e.data.variableName);const t={id:e.id,src:e.data?.isVariable&&e.data?.originalSrc?e.data.originalSrc:e.src,width:e.width,height:e.height,left:e.left,top:e.top,scaleX:e.scaleX||1,scaleY:e.scaleY||1,angle:e.angle||0,opacity:void 0!==e.opacity?e.opacity:1,originX:e.originX||"left",originY:e.originY||"top",selectable:!1!==e.selectable,hasControls:!1!==e.hasControls,hasBorders:!1!==e.hasBorders,data:{...e.data}};console.log("ðŸ”§ Creating ImageElement with options:",t);const i=new n(null,t);i.set({stroke:e.stroke,strokeWidth:e.strokeWidth,strokeDashArray:e.strokeDashArray,fill:e.fill,selectable:!1!==e.selectable,hasControls:!1!==e.hasControls,hasBorders:!1!==e.hasBorders}),a.add(i),this._applyHybridClearingToElement(i),this._reregisterElementWithPlaceholderManager(i)}else fabric.util.enlivenObjects([e],(e=>{e.forEach((e=>{let t=e;if("i-text"===e.type)t=new s({...t});else if("image"===e.type){const e={id:t.id,src:t.src,width:t.width,height:t.height,left:t.left,top:t.top,scaleX:t.scaleX||1,scaleY:t.scaleY||1,angle:t.angle||0,opacity:void 0!==t.opacity?t.opacity:1,originX:t.originX||"left",originY:t.originY||"top",selectable:!1!==t.selectable,hasControls:!1!==t.hasControls,hasBorders:!1!==t.hasBorders,data:t.data?{...t.data}:{}};t=new n(null,e)}else console.log("Danger : ============");a.add(t),this._applyHybridClearingToElement(t),this._reregisterElementWithPlaceholderManager(t)}))}))})),a.requestRenderAll(),a.setZoom(this.zoom),Object.keys(this.placeholderManager.currentData).length>0&&(console.log(`ðŸ”„ Applying current variable data to page ${e}:`,this.placeholderManager.currentData),await this.placeholderManager._applyDataToCurrentPage()))}async generateModifiedPDFWithDebug(e=null){console.log("ðŸ” === STARTING PDF GENERATION DEBUG ==="),console.log("FontKit instance provided:",!!e),this.saveCurrentPageElements();const{PDFDocument:t,rgb:a,degrees:i}=window.PDFLib,s=await this.pdfDoc.getData(),n=await t.load(s);e&&"function"==typeof n.registerFontkit&&(n.registerFontkit(e),console.log("âœ… FontKit registered with PDF document"));const o=new Set;for(let e=1;e<=this.pageCount;e++){(this.pageElements[e]||[]).forEach((e=>{"i-text"===e.type&&e.fontFamily&&o.add(e.fontFamily)}))}console.log("ðŸ” Fonts used in document:",Array.from(o)),console.log("ðŸ” FontManager custom fonts:",Array.from(this.fontManager.customFonts.keys()));for(let t=1;t<=this.pageCount;t++){const a=n.getPage(t-1),s=this.pageElements[t]||[],o=a.getHeight(),r=1;console.log(`ðŸ” Processing page ${t} with ${s.length} elements`);for(const t of s)if("i-text"===t.type){console.log("ðŸ” Processing text element:",{text:t.text?.substring(0,20)+"...",fontFamily:t.fontFamily,fontSize:t.fontSize});try{const s="bold"===t.fontWeight||"700"===t.fontWeight||t.fontWeight>600,l="italic"===t.fontStyle;console.log(`ðŸŽ¯ Font styles - Bold: ${s}, Italic: ${l}`);const d=await this.fontManager.embedFont(n,t.fontFamily||"Helvetica",{bold:s,italic:l,fontkitInstance:e});console.log("ðŸ“‹ Font embedded:",{name:d.name,expectedFamily:t.fontFamily});const c=t.left/r,h=t.top/r,g=t.height*(t.scaleY||1)/r,m=(t.fontSize||16)/r;let p=c,u=o-h;"center"===t.originX&&(p-=t.width*(t.scaleX||1)/r/2),"center"===t.originY&&(u+=g/2);const f=this.placeholderManager.processTextForPDF(t.text||""),v={x:p,y:u-g,size:m,font:d,color:this.parseColor(t.fill||"#000000"),rotate:i(t.angle||0),opacity:void 0!==t.opacity?t.opacity:1};console.log(`ðŸ“ Drawing text with font: ${d.name}`),a.drawText(f,v)}catch(e){console.error("âŒ Error processing text element:",e)}}}const r=await n.save();return console.log("âœ… === PDF GENERATION COMPLETED ==="),r}async downloadPDF(e="modified.pdf"){try{console.log("ðŸ” Starting PDF download with debug...");const t=window.fontIntegration,a=await t.getFontkit();console.log("FontKit loaded:",!!a);const i=await this.generateModifiedPDFWithDebug(a),s=new Blob([i],{type:"application/pdf"}),n=URL.createObjectURL(s),o=document.createElement("a");o.href=n,o.download=e,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(n),console.log("âœ… PDF download completed")}catch(e){throw console.error("âŒ Error downloading PDF:",e),e}}parseColor(e){const{rgb:t}=window.PDFLib;if(e.startsWith("#")){return t(parseInt(e.substr(1,2),16)/255,parseInt(e.substr(3,2),16)/255,parseInt(e.substr(5,2),16)/255)}if(e.startsWith("rgb")){const a=e.match(/\d+/g);return t(parseInt(a[0])/255,parseInt(a[1])/255,parseInt(a[2])/255)}return t(0,0,0)}async registerFont(e,t){return this.fontManager.registerFont(e,t)}getRegisteredFonts(){return this.fontManager.getRegisteredFontFamilies()}isFontAvailable(e){return this.fontManager.isFontAvailable(e)}trackFontUsage(e){e&&!this.usedFonts.has(e)&&(this.usedFonts.add(e),this.dispatchEvent(new CustomEvent("font-usage",{detail:{fontFamily:e}})))}getUsedFonts(){return Array.from(this.usedFonts)}getMissingFonts(){const e=this.getUsedFonts(),t=[];for(const a of e)this.fontManager.isFontReady(a)||this.fontManager.isStandardFont(a)||t.push(a);return t}async verifyAndRequestMissingFonts(e={}){const t=this.getMissingFonts();if(console.log("Missing fonts: ",t),0===t.length)return!0;const a=[],i=new CustomEvent("fonts-required",{detail:{missingFonts:t,registerFont:(e,t)=>{try{const i=this.fontManager.registerFont(e,t);return a.push(i),i}catch(e){return console.warn(`registerFont threw: ${e.message}`),Promise.reject(e)}}}});if(this.dispatchEvent(i),await Promise.resolve(),a.length>0)try{return await Promise.race([Promise.all(a),new Promise(((t,a)=>setTimeout((()=>a(new Error("Font loading timed out"))),e.fontTimeout||5e3)))]),!0}catch(e){return console.warn("Font loading issue:",e),!1}return!0}getSupportedFontsByCategory(){return this.fontManager.getFontsByCategory()}getAllSupportedFonts(){return this.fontManager.getAllFonts()}getReadyFonts(){return this.fontManager.getReadyFonts()}getFontDetails(){return this.fontManager.getFontDetails()}isFontReady(e){return this.fontManager.isFontReady(e)}isStandardFont(e){return this.fontManager.isStandardFont(e)}getFontStatus(e){return this.fontManager.getFontStatus(e)}getDocumentVariables(){return this.placeholderManager.getAllVariables()}getTextVariables(){return this.placeholderManager.getTextVariables()}getImageVariables(){return this.placeholderManager.getImageVariables()}async applyData(e,t=!0){return await this.placeholderManager.applyData(e,t)}async clearData(){return await this.placeholderManager.clearData()}setImageSrc(e){this.isEditMode?this.elementManager.setImageSrc(e):console.warn("Not in edit mode")}setImageVariable(e){this.isEditMode?this.elementManager.setImageVariable(e):console.warn("Not in edit mode")}addImageVariable(e,t={}){if(!this.isEditMode)return Promise.reject(new Error("Not in edit mode"));const a=this.elementManager.canvas,i={left:a.getCenter().left,top:a.getCenter().top,data:{pageNumber:this.currentPage},...t};return this.elementManager.addImageVariable(e,i)}validateVariables(e){return this.placeholderManager.validateVariables(e)}isSelectedImageVariable(){const e=this.elementManager.getActiveImageElement();return e&&e.data?.isVariable}getSelectedImageVariableName(){const e=this.elementManager.getActiveImageElement();return e&&e.data?.isVariable?e.data.variableName:null}getSelectedImageInfo(){const e=this.elementManager.getImageProperties();return e?{...e,canConvertToVariable:!e.isVariable,canConvertToStatic:e.isVariable,hasVariableData:e.isVariable&&!!e.variableName}:null}async generateModifiedPDFWithVariables(e=null,t=null){console.log("ðŸ” === STARTING PDF GENERATION WITH VARIABLES ==="),console.log("Variable data provided:",!!t),this.saveCurrentPageElements();const{PDFDocument:a,rgb:i,degrees:s}=window.PDFLib,n=await this.pdfDoc.getData(),o=await a.load(n);e&&"function"==typeof o.registerFontkit&&(o.registerFontkit(e),console.log("âœ… FontKit registered with PDF document"));let r=null;t&&(r={...this.placeholderManager.currentData},await this.placeholderManager.applyData(t,!1));try{for(let t=1;t<=this.pageCount;t++){const a=o.getPage(t-1),i=this.pageElements[t]||[],s=a.getHeight(),n=1;console.log(`ðŸ” Processing page ${t} with ${i.length} elements`);for(const t of i)try{"i-text"===t.type?await this.processTextElementForPDF(a,t,s,n,o,e):"image"===t.type&&await this.processImageElementForPDF(a,t,s,n,o)}catch(e){console.error("âŒ Error processing element:",e)}}const t=await o.save();return console.log("âœ… === PDF GENERATION WITH VARIABLES COMPLETED ==="),t}finally{t&&r&&(this.placeholderManager.currentData=r,await this.placeholderManager._applyDataToCurrentPage())}}async processTextElementForPDF(e,t,a,i,s,n){const{degrees:o}=window.PDFLib;console.log("ðŸ“ Processing text element:",{text:t.text?.substring(0,20)+"...",fontFamily:t.fontFamily,fontSize:t.fontSize});try{const l="bold"===t.fontWeight||"700"===t.fontWeight||t.fontWeight>600,d="italic"===t.fontStyle,c=await this.fontManager.embedFont(s,t.fontFamily||"Helvetica",{bold:l,italic:d,fontkitInstance:n}),h=c.embedder.font;console.log("Font metrics",h);const g=h.Descender/1e3*(t.fontSize/i)||0,m=t.left/i,p=t.top/i,u=(t.width,t.scaleX,t.height*(t.scaleY||1)/i),f=(t.fontSize||16)/i;console.log(c);var r=u-f*t.lineHeight;const v=e.getMediaBox().y;let b=m,E=a-p-u+r+f/9+v;const y=this.placeholderManager.processTextForPDF(t.text||""),w={x:b,y:E,size:f,font:c,color:this.parseColor(t.fill||"#000000"),rotate:o(t.angle||0),opacity:void 0!==t.opacity?t.opacity:1};console.log("textY, normalizedHeight, descent",E,u,g),console.log(`ðŸ“ Drawing text at position: x=${b}, y=${E-u-g} with font: ${c.name}`),e.drawText(y,w)}catch(e){console.error("âŒ Error processing text element:",e)}}calculateFontDescent(e,t){let a=0;try{const i=e.embedder?.font||e;if(i){if(void 0!==i.descent&&!isNaN(i.descent))return a=i.descent/1e3*t,console.log(`âœ… Using FontKit descent: ${i.descent} -> ${a}`),a;if(i.hhea&&void 0!==i.hhea.descent&&!isNaN(i.hhea.descent))return a=i.hhea.descent/1e3*t,console.log(`âœ… Using hhea descent: ${i.hhea.descent} -> ${a}`),a;if(i["OS/2"]&&void 0!==i["OS/2"].descent&&!isNaN(i["OS/2"].descent))return a=i["OS/2"].descent/1e3*t,console.log(`âœ… Using OS/2 descent: ${i["OS/2"].descent} -> ${a}`),a;if(i.bbox&&void 0!==i.bbox.minY&&!isNaN(i.bbox.minY))return a=i.bbox.minY/1e3*t,console.log(`âœ… Using bbox.minY descent: ${i.bbox.minY} -> ${a}`),a}if(e.embedder&&e.embedder.font&&e.embedder.font.Descender){const i=e.embedder.font.Descender;if(!isNaN(i)&&0!==i)return a=i/1e3*t,console.log(`âœ… Using FontKit Descender: ${i} -> ${a}`),a}if(void 0!==e.descent&&!isNaN(e.descent))return a=e.descent*t,console.log(`âœ… Using PDF-lib descent: ${e.descent} -> ${a}`),a;const s=[i?.descent,i?.descender,i?.Descent,i?.TypoDescender,i?.WinDescent,i?.typoDescender];for(const e of s)if(void 0!==e&&!isNaN(e)&&0!==e){return a=(Math.abs(e)>10?e/1e3:e)*t,console.log(`âœ… Using alternative descender: ${e} -> ${a}`),a}const n=e.name||"",o=n.toLowerCase();return a=o.includes("helvetica")||o.includes("arial")?.207*t:o.includes("times")?.217*t:o.includes("courier")?.157*t:.2*t,console.log(`âš ï¸ Using fallback descent for ${n}: ${a}`),a}catch(e){return console.warn("âš ï¸ Error calculating font descent:",e),a=.2*t,console.log(`ðŸ”§ Using ultimate fallback descent: ${a}`),a}}async processImageElementForPDF(e,t,a,i,s){const{degrees:n}=window.PDFLib;console.log("ðŸ–¼ï¸ Processing image element:",{isVariable:t.data?.isVariable,variableName:t.data?.variableName,src:t.src?.substring(0,50)+"..."});let o=t.src;if(t.data?.isVariable&&t.data?.variableName){const e=this.placeholderManager.processImageForPDF(t.src,t.data.variableName);if(!t.data?.isVariable||!t.data?.variableName)return void console.warn(`âš ï¸ No data provided for image variable: ${t.data.variableName}`);o=e,console.log(`ðŸ”„ Replaced variable ${t.data.variableName} with actual image`)}const r={canavasHeight:a,elemenetTop:t.top,height:t.height*(t.scaleY||1)/i};console.log("ankit",r);const l=t.left/i,d=t.top/i,c=t.width*(t.scaleX||1)/i,h=t.height*(t.scaleY||1)/i;let g=l,m=a-d-h;"center"===t.originX&&(g-=c/2),"center"===t.originY&&(m+=h/2);try{let a,i;if(o.startsWith("data:")){const e=o.split(",")[1];a=Uint8Array.from(atob(e),(e=>e.charCodeAt(0)))}else{const e=await fetch(o);a=new Uint8Array(await e.arrayBuffer())}i=o.toLowerCase().includes("png")||o.startsWith("data:image/png")?await s.embedPng(a):await s.embedJpg(a),e.drawImage(i,{x:g,y:m,width:c,height:h,opacity:void 0!==t.opacity?t.opacity:1,rotate:n(t.angle||0)}),console.log("âœ… Image processed successfully")}catch(e){console.error("âŒ Error processing image:",e)}}async downloadPDFWithVariables(e="modified.pdf",t=null){try{console.log("ðŸ” Starting PDF download with variables...");const a=window.fontIntegration,i=await a.getFontkit();console.log("FontKit loaded:",!!i);const s=await this.generateModifiedPDFWithVariables(i,t),n=new Blob([s],{type:"application/pdf"}),o=URL.createObjectURL(n),r=document.createElement("a");r.href=o,r.download=e,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(o),console.log("âœ… PDF download with variables completed")}catch(e){throw console.error("âŒ Error downloading PDF with variables:",e),e}}async downloadPDFNew(e="modified.pdf"){return this.downloadPDFWithVariables(e,this.placeholderManager.currentData)}async generateModifiedPDF(){const e=window.fontIntegration,t=await e.getFontkit();return this.generateModifiedPDFWithVariables(t,this.placeholderManager.currentData)}async addBlankPage(e={}){const{width:t=612,height:a=792,navigateToPage:s=!0}=e;this.isLoading=!0,this.error=null;try{const{PDFDocument:e}=window.PDFLib;let n;if(this.isPDFLoaded&&this.pdfDoc){console.log("Adding blank page to existing PDF"),this.saveCurrentPageElements();const s=await this.pdfDoc.getData(),o=await e.load(s),r=(o.addPage([t,a]),await o.save());this.pdfDoc=await i.getDocument(r).promise,this.pageCount=this.pdfDoc.numPages,this.blankPageCount++,n=this.pageCount,this.pageElements[n]=[]}else{console.log("Creating new PDF with blank page"),await this.setupPDFWorker();const s=await e.create(),o=(s.addPage([t,a]),await s.save());this.cleanup(),this.pdfDoc=await i.getDocument(o).promise,this.pageCount=this.pdfDoc.numPages,this.isPDFLoaded=!0,this.pdfPageCount=0,this.blankPageCount=1,this.pdfInfo=null,n=1,await this.renderPage(1),this.dispatchEvent(new CustomEvent("pdf-loaded",{detail:{pageCount:this.pageCount,isNewDocument:!0}}))}return s&&await this.renderPage(n),this.dispatchEvent(new CustomEvent("page-added",{detail:{pageNumber:n,totalPages:this.pageCount,width:t,height:a}})),console.log(`âœ… Blank page added successfully as page ${n}`),n}catch(e){throw this.handleError(new Error(`Failed to add blank page: ${e.message}`)),e}finally{this.isLoading=!1}}async addBlankPages(e,t={}){if(!Number.isInteger(e)||e<1)throw new Error("Count must be a positive integer");const a=[],i=t.navigateToPage;try{const s={...t,navigateToPage:!1};for(let t=0;t<e;t++){const e=await this.addBlankPage(s);a.push(e)}return!1!==i&&a.length>0&&await this.renderPage(a[a.length-1]),a}catch(e){throw console.error("Error adding multiple blank pages:",e),e}}async insertBlankPage(e,t={}){if(!this.isPDFLoaded||!this.pdfDoc)return this.addBlankPage(t);if(e<1||e>this.pageCount+1)throw new Error(`Invalid position: ${e}. Must be between 1 and ${this.pageCount+1}`);const{width:a=612,height:s=792,navigateToPage:n=!0}=t;this.isLoading=!0,this.error=null;try{this.saveCurrentPageElements();const t=await this.pdfDoc.getData(),o=await PDFDocument.load(t),r=(o.insertPage(e-1,[a,s]),await o.save());this.pdfDoc=await i.getDocument(r).promise,this.pageCount=this.pdfDoc.numPages;const l={};for(const[t,a]of Object.entries(this.pageElements)){const i=parseInt(t);i>=e?l[i+1]=a:l[i]=a}return l[e]=[],this.pageElements=l,n&&await this.renderPage(e),this.dispatchEvent(new CustomEvent("page-inserted",{detail:{pageNumber:e,totalPages:this.pageCount,width:a,height:s}})),console.log(`âœ… Blank page inserted successfully at position ${e}`),e}catch(e){throw this.handleError(new Error(`Failed to insert blank page: ${e.message}`)),e}finally{this.isLoading=!1}}getVariableSummary(){const e=this.getDocumentVariables(),t=this.getTextVariables(),a=this.getImageVariables();return{all:{count:e.length,variables:e},text:{count:t.length,variables:t},images:{count:a.length,variables:a},hasVariables:e.length>0}}_applyHybridClearingToElement(e){if(!e?.data)return;0===Object.keys(this.placeholderManager.currentData).length&&(console.log(`ðŸ” Hybrid clearing check: _isRestoringState = ${this._isRestoringState} for element ${e.id}`),this._isRestoringState?console.log(`â­ï¸ Skipping hybrid clearing during state restoration for element ${e.id}`):e.data.hasVariables||e.data.isVariable?(console.log(`ðŸ”„ Hybrid clearing: Restoring element ${e.id} to template state`),e.data.hasVariables&&e.data.originalText&&(console.log(`ðŸ“ Restoring text element to: "${e.data.originalText}"`),e.set("text",e.data.originalText)),e.data.isVariable&&e.data.originalSrc&&(console.log("ðŸ–¼ï¸ Restoring image element to original src"),e.setSrc(e.data.originalSrc))):console.log(`â­ï¸ Skipping hybrid clearing for non-variable element ${e.id}`))}_reregisterElementWithPlaceholderManager(e){e?.data&&(e.data.hasVariables&&e.data.variableInfo?(console.log("ðŸ”„ Re-registering text element with variables:",e.data.variableInfo),this.placeholderManager._analyzeTextForPlaceholders(e)):e.data.isVariable&&e.data.variableName&&(console.log("ðŸ”„ Re-registering image element with variable:",e.data.variableName),this.placeholderManager._analyzeImageForPlaceholders(e,e.data)))}hasVariables(){return this.getDocumentVariables().length>0}setGlobalImagePlaceholder(e){this.globalImagePlaceholder=e,n.globalPlaceholder=e,console.log(`ðŸ–¼ï¸ Global image placeholder set: ${e}`)}getGlobalImagePlaceholder(){return this.globalImagePlaceholder}clearGlobalImagePlaceholder(){this.globalImagePlaceholder=null,n.globalPlaceholder=null,console.log("ðŸ–¼ï¸ Global image placeholder cleared")}configureActionIcons(e){this.actionIconManager&&this.actionIconManager.configureControls(e)}addCustomActionIcon(e,t,a){this.actionIconManager&&this.actionIconManager.addCustomIcon(e,t,a)}removeCustomActionIcon(e){this.actionIconManager&&this.actionIconManager.removeCustomIcon(e)}getActionIconsConfiguration(){return this.actionIconManager?this.actionIconManager.getConfiguration():null}setActionIconsEnabled(e){this.actionIconManager&&this.actionIconManager.setEnabled(e)}getMissingVariables(e={}){return this.validateVariables(e).missingVariables}getCompleteState(){return this.stateManager.getCompleteState()}getAllPagesData(){return this.stateManager.getAllPagesData()}getVariablesData(){return this.stateManager.getVariablesData()}getFontsData(){return this.stateManager.getFontsData()}getStateSummary(){return this.stateManager.getStateSummary()}getPDFGenerationData(){return this.stateManager.getPDFGenerationData()}async restoreCompleteState(e){return this.stateManager.restoreCompleteState(e)}exportStateAsJSON(e=!1){return this.stateManager.exportStateAsJSON(e)}async importStateFromJSON(e){return this.stateManager.importStateFromJSON(e)}hasUnsavedChanges(){return this.stateManager.hasUnsavedChanges()}markAsSaved(){this.stateManager.markAsSaved()}createSavePayload(e,t={}){return this.stateManager.createSavePayload(e,t)}createIncrementalSavePayload(e){return this.stateManager.createIncrementalSavePayload(e)}cleanupElements(){const e=this.elementManager.canvas;e&&e.clear(),this.pageElements={}}}customElements.define("pdf-editor",g);export{g as PDFEditor};
